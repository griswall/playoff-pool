<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Hurd NFL Playoff Pool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- 1. Import Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <!-- Runtime Supabase configuration (replace values or set window.__SUPABASE_CONFIG__) -->
    <script id="supabase-config" type="application/json">
        {"url":"YOUR_SUPABASE_URL","anonKey":"YOUR_SUPABASE_ANON_KEY","adminEmails":["admin@example.com"]}
    </script>
    <style>
        :root {
            --accent: #00d084;
            --accent-hover: #00b371;
            --bg-deep: #0f1115;
            --bg-medium: #1c1e24;
            --bg-light: #292d36;
            --text-primary: #e5e7eb;
            --text-muted: #9ca3af;
            --error: #ef4444;
            --yellow: #facc15;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-primary);
        }
        .main-header {
            background-color: var(--bg-medium);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--bg-light);
        }
        .content-section {
            background-color: var(--bg-medium);
            border: 1px solid var(--bg-light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .form-input {
            background-color: var(--bg-deep);
            border: 1px solid var(--bg-light);
            color: var(--text-primary);
            border-radius: 0.375rem;
            width: 70px;
            padding: 0.5rem 0.75rem;
            text-align: center;
        }
        /* Remove arrows from number inputs */
        input[type="text"] {
            -moz-appearance: textfield;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.3);
        }
        .admin-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .admin-table th, .admin-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--bg-light); 
        }
        .admin-table th {
            background-color: var(--bg-light);
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        .admin-table tbody tr:hover { background-color: var(--bg-light); }
        .sticky-header { position: sticky; top: 0; z-index: 10; }
        
        .save-button {
            background-color: var(--accent);
            color: #000;
            font-weight: 700;
            transition: background-color 0.2s;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
        }
        .save-button:hover {
            background-color: var(--accent-hover);
        }
        .save-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="main-header">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <h1 class="text-3xl font-extrabold text-white tracking-tight">Admin Score Panel</h1>
                <a href="index.html" class="text-sm font-semibold text-[var(--accent)] hover:text-[var(--accent-hover)]">&larr; Back to Main Site</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="content-section max-w-5xl mx-auto">
            <h2 class="text-2xl sm:text-3xl font-extrabold text-white mb-6">Enter Player Scores</h2>
            <div class="overflow-x-auto">
                <table id="scores-table" class="admin-table min-w-full">
                    <thead class="sticky-header">
                        <tr>
                            <th>Player</th>
                            <th class="text-center">WC</th>
                            <th class="text-center">DIV</th>
                            <th class="text-center">CONF</th>
                            <th class="text-center">SB</th>
                        </tr>
                    </thead>
                    <tbody id="scores-table-body">
                        <!-- Player rows will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-right">
                <button id="save-scores-btn" class="save-button">Save All Scores</button>
            </div>
        </div>
    </main>

    <div id="loading-overlay" class="loading-overlay" role="status" aria-live="polite">
        <div class="loading-spinner" aria-label="Loading"></div>
    </div>

    <script type="module">
        // =================================================================================
        // --- SUPABASE & APP INITIALIZATION ---
        // =================================================================================
        
        // **This imports your new supabaseClient.js file**
        import { getSupabaseClient, getSupabaseConfig } from './scripts/supabaseClient.js';

        let supabaseClient;
        let allPlayers = []; // To store fetched players
        let playerScores = {}; // To store fetched scores { "player_id-round": points }
        const dirtyScoreInputs = new Map();
        let adminAllowList = [];

        try {
            const config = getSupabaseConfig();
            adminAllowList = Array.isArray(config.adminEmails)
                ? config.adminEmails
                    .map(email => (typeof email === 'string' ? email.trim().toLowerCase() : ''))
                    .filter(Boolean)
                : [];
            supabaseClient = getSupabaseClient();
        } catch (e) {
            console.error("Error initializing Supabase.", e.message);
            alert("CRITICAL ERROR: Could not connect to Supabase. Check console.");
        }

        // --- DOM REFERENCES ---
        const uiElements = {
            tableBody: document.getElementById('scores-table-body'),
            saveButton: document.getElementById('save-scores-btn'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        // =================================================================================
        // --- APP INITIALIZATION ---
        // =================================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            if (!supabaseClient) {
                showLoading(false);
                return;
            }
            showLoading(true);
            checkUserAndLoadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            uiElements.saveButton?.addEventListener('click', handleSaveScores);
        }

        // =================================================================================
        // --- AUTH & DATA FETCHING ---
        // =================================================================================

        /**
         * Checks for an active Supabase session. Redirects to login if not found.
         * Then, loads all data.
         */
        async function checkUserAndLoadData() {
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                window.location.href = "login.html"; // Redirect if no session
                return;
            }

            if (adminAllowList.length > 0) {
                const userEmail = (data.session.user?.email || '').toLowerCase();
                const isAllowed = adminAllowList.includes(userEmail);
                if (!isAllowed) {
                    alert("Access Denied: This page is for administrators only.");
                    await supabaseClient.auth.signOut();
                    window.location.href = "index.html";
                    return;
                }
            }

            await fetchAllData();
        }

        /**
         * Fetches all players and all existing scores from the database.
         */
        async function fetchAllData() {
            try {
                const [
                    { data: playersData, error: playersError },
                    { data: scoresData, error: scoresError }
                ] = await Promise.all([
                    supabaseClient
                        .from('players')
                        .select('id, name, team, position')
                        .order('name', { ascending: true }),
                    supabaseClient
                        .from('player_scores')
                        .select('player_id, playoff_round, points')
                ]);

                if (playersError) throw playersError;
                if (scoresError) throw scoresError;

                allPlayers = Array.isArray(playersData) ? playersData : [];
                playerScores = mapScoresByPlayerAndRound(scoresData || []);

                renderScoresTable();

            } catch (error) {
                console.error("Error fetching data:", error.message);
                alert("Error: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function refreshScores(playerIds = []) {
            const uniqueIds = Array.from(
                new Set(
                    (Array.isArray(playerIds) ? playerIds : [])
                        .map(id => (typeof id === 'number' ? id : Number.parseInt(id, 10)))
                        .filter(id => Number.isInteger(id) && id > 0)
                )
            );

            if (uniqueIds.length === 0) {
                return;
            }

            try {
                const { data: scoresData, error } = await supabaseClient
                    .from('player_scores')
                    .select('player_id, playoff_round, points')
                    .in('player_id', uniqueIds);

                if (error) throw error;

                const updatedScores = { ...playerScores };
                const validRounds = ['WC', 'DIV', 'CONF', 'SB'];

                uniqueIds.forEach(playerId => {
                    validRounds.forEach(round => {
                        delete updatedScores[`${playerId}-${round}`];
                    });
                });

                (scoresData || []).forEach(score => {
                    if (!score || !validRounds.includes(score.playoff_round)) return;
                    const normalizedId = Number.parseInt(score.player_id, 10);
                    if (!Number.isInteger(normalizedId)) return;
                    updatedScores[`${normalizedId}-${score.playoff_round}`] = score.points;
                });

                playerScores = updatedScores;
            } catch (error) {
                console.error("Error refreshing scores:", error.message);
                alert("Scores saved but could not refresh latest values. " + error.message);
            }
        }

        function mapScoresByPlayerAndRound(scores = []) {
            return scores.reduce((acc, score) => {
                if (typeof score?.player_id === 'undefined' || !score?.playoff_round) return acc;
                const key = `${score.player_id}-${score.playoff_round}`;
                acc[key] = score.points;
                return acc;
            }, {});
        }

        function handleScoreInputChange(event) {
            const input = event.currentTarget;
            if (!(input instanceof HTMLInputElement)) {
                return;
            }

            const playerId = Number.parseInt(input.dataset.playerId || '', 10);
            const round = input.dataset.round || '';
            if (!Number.isInteger(playerId) || !round) {
                return;
            }

            const key = `${playerId}-${round}`;
            const rawValue = input.value.trim();
            let normalizedValue = null;
            let isValid = true;

            if (rawValue === '') {
                normalizedValue = null;
            } else {
                const numericValue = Number(rawValue);
                if (!Number.isFinite(numericValue)) {
                    isValid = false;
                } else {
                    normalizedValue = numericValue;
                }
            }

            if (!isValid) {
                input.classList.add('border-red-500');
                dirtyScoreInputs.set(key, {
                    playerId,
                    round,
                    rawValue,
                    value: Number.NaN,
                    input
                });
                return;
            }

            input.classList.remove('border-red-500');

            const existingScore = Object.prototype.hasOwnProperty.call(playerScores, key)
                ? playerScores[key]
                : undefined;
            const normalizedExisting = existingScore === undefined ? null : existingScore;

            if (normalizedExisting === normalizedValue) {
                dirtyScoreInputs.delete(key);
                return;
            }

            dirtyScoreInputs.set(key, {
                playerId,
                round,
                rawValue,
                value: normalizedValue,
                input
            });
        }

        // =================================================================================
        // --- CORE ADMIN LOGIC ---
        // =================================================================================
        
        /**
         * Gathers all score data from the table and sends it to the Supabase function.
         */
        async function handleSaveScores() {
            if (dirtyScoreInputs.size === 0) {
                alert("No score changes detected.");
                return;
            }

            setSaveButtonState(true);
            showLoading(true);
            const scoreUpdates = [];
            const updatedPlayerIds = new Set();
            const invalidEntries = [];

            dirtyScoreInputs.forEach(entry => {
                if (!entry) return;
                const { playerId, round, value, input } = entry;
                if (!Number.isInteger(playerId) || !round) {
                    return;
                }

                const key = `${playerId}-${round}`;
                const existingScore = Object.prototype.hasOwnProperty.call(playerScores, key)
                    ? playerScores[key]
                    : undefined;
                const normalizedExisting = existingScore === undefined ? null : existingScore;

                if (value !== null && !Number.isFinite(value)) {
                    invalidEntries.push(entry);
                    if (input) {
                        input.classList.add('border-red-500');
                    }
                    return;
                }

                const normalizedPoints = value === null ? null : Number(value);
                if (normalizedExisting === normalizedPoints) {
                    dirtyScoreInputs.delete(key);
                    return;
                }

                scoreUpdates.push({
                    player_id_to_update: playerId,
                    round_to_update: round,
                    points_to_update: normalizedPoints
                });
                updatedPlayerIds.add(playerId);
            });

            if (invalidEntries.length > 0) {
                showLoading(false);
                setSaveButtonState(false);
                const firstInvalid = invalidEntries[0];
                if (firstInvalid?.input) {
                    firstInvalid.input.focus();
                }
                alert("Please enter valid numeric scores before saving.");
                return;
            }

            if (scoreUpdates.length === 0) {
                alert("No score changes detected.");
                showLoading(false);
                setSaveButtonState(false);
                return;
            }

            try {
                const { error } = await supabaseClient.rpc('bulk_upsert_player_scores', {
                    scores_to_update: scoreUpdates
                });

                if (error) throw error;

                alert("Scores saved successfully!");
                scoreUpdates.forEach(update => {
                    const key = `${update.player_id_to_update}-${update.round_to_update}`;
                    playerScores[key] = update.points_to_update;
                });
                dirtyScoreInputs.clear();
                await refreshScores(Array.from(updatedPlayerIds));
                syncInputsWithScores();

            } catch (error) {
                console.error("Error saving scores:", error.message);
                alert("Error: " + error.message);
            } finally {
                showLoading(false);
                setSaveButtonState(false);
            }
        }

        // =================================================================================
        // --- UI RENDERING ---
        // =================================================================================
        
        /**
         * Renders the main scores table.
         */
        function renderScoresTable() {
            if (!uiElements.tableBody) return;
            uiElements.tableBody.replaceChildren();
            dirtyScoreInputs.clear();
            const fragment = document.createDocumentFragment();
            const rounds = ['WC', 'DIV', 'CONF', 'SB'];

            allPlayers.forEach(player => {
                const row = document.createElement('tr');

                const playerCell = document.createElement('td');
                playerCell.className = 'whitespace-nowrap';

                const playerName = document.createElement('div');
                playerName.className = 'font-semibold';
                playerName.textContent = player?.name || 'Unknown Player';

                const playerMeta = document.createElement('div');
                playerMeta.className = 'text-xs text-[var(--text-muted)]';
                const position = player?.position || 'N/A';
                const team = player?.team || 'N/A';
                playerMeta.textContent = `${position} - ${team}`;

                playerCell.appendChild(playerName);
                playerCell.appendChild(playerMeta);
                row.appendChild(playerCell);

                rounds.forEach(round => {
                    const cell = document.createElement('td');
                    cell.className = 'text-center';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.inputMode = 'decimal';
                    input.pattern = '[0-9.-]*';
                    input.className = 'form-input';
                    const playerIdValue = typeof player?.id !== 'undefined' ? String(player.id) : '';
                    if (playerIdValue) {
                        input.dataset.playerId = playerIdValue;
                        const scoreKey = `${playerIdValue}-${round}`;
                        const existingScore = playerScores[scoreKey];
                        if (existingScore !== undefined && existingScore !== null) {
                            input.value = String(existingScore);
                        }
                    }
                    input.dataset.round = round;
                    input.placeholder = '0.0';
                    input.addEventListener('input', handleScoreInputChange);

                    cell.appendChild(input);
                    row.appendChild(cell);
                });

                fragment.appendChild(row);
            });

            uiElements.tableBody.appendChild(fragment);
        }

        function syncInputsWithScores() {
            if (!uiElements.tableBody) return;
            dirtyScoreInputs.clear();
            const inputs = uiElements.tableBody.querySelectorAll('input[data-player-id][data-round]');
            inputs.forEach(input => {
                const playerId = input.dataset.playerId;
                const round = input.dataset.round;
                if (!playerId || !round) return;

                const key = `${playerId}-${round}`;
                const value = playerScores[key];
                if (value === null || typeof value === 'undefined') {
                    input.value = '';
                } else {
                    input.value = String(value);
                }
                input.classList.remove('border-red-500');
            });
        }

        function showLoading(isLoading) {
            uiElements.loadingOverlay?.classList.toggle('active', isLoading);
        }

        function setSaveButtonState(isBusy) {
            if (!uiElements.saveButton) return;
            uiElements.saveButton.disabled = isBusy;
            uiElements.saveButton.setAttribute('aria-busy', String(isBusy));
        }

    </script>
</body>
</html>
