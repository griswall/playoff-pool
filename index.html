<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hurd NFL Playoff Pool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            DEFAULT: '#00d084',
                            dark: '#00a366',
                            glow: 'rgba(0, 208, 132, 0.5)'
                        },
                        surface: {
                            100: '#1e293b',
                            200: '#334155',
                            300: '#475569',
                            800: '#0f172a',
                            900: '#020617',
                        }
                    },
                    backgroundImage: {
                        'main-gradient': 'radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --accent: #00d084;
            --accent-glow: rgba(0, 208, 132, 0.4);
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
        }
        
        body {
            background: #020617;
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #020617 60%);
            background-attachment: fixed;
            color: #f8fafc;
            min-height: 100vh;
            /* Mobile Footer Padding */
            padding-bottom: 100px; 
        }
        /* Desktop: Remove padding */
        @media (min-width: 1280px) {
            body { padding-bottom: 0; }
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
        }
        
        .glass-header {
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Nav Active State Indicator */
        .nav-link { position: relative; transition: color 0.2s; cursor: pointer; }
        .nav-link.active::after {
            content: ''; position: absolute; bottom: -21px; left: 0; width: 100%; height: 3px;
            background: var(--accent); box-shadow: 0 -2px 10px var(--accent-glow); border-radius: 2px 2px 0 0;
        }

        /* COMPACT PLAYER CARD DESIGN */
        .player-card {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--card-bg); border: 1px solid var(--card-border);
            padding: 0.75rem; border-radius: 0.75rem; 
            transition: border-color 0.2s, background-color 0.2s;
            cursor: pointer; position: relative; overflow: hidden;
            transform: translateZ(0); /* Prevents mobile flickering */
        }
        
        /* Desktop Hover Only */
        @media (hover: hover) {
            .player-card:not(.player-drafted):not(.player-unavailable):hover {
                transform: translateX(4px); 
                border-color: var(--accent);
                background: rgba(30, 41, 59, 0.95); 
                box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.3);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
        
        .player-card:active {
            background: rgba(30, 41, 59, 0.95);
            border-color: var(--accent);
        }

        .player-card.player-drafted { 
            opacity: 0.5 !important; filter: grayscale(100%) !important; pointer-events: none !important; 
            border-color: rgba(255,255,255,0.05) !important;
        }
        .player-card.player-unavailable { 
            opacity: 0.3 !important; pointer-events: none !important; background: rgba(0,0,0,0.2) !important;
        }
        
        .draft-flash { animation: flashHighlight 0.5s ease-out; }
        @keyframes flashHighlight {
            0% { background-color: var(--accent); border-color: var(--accent); }
            100% { background-color: var(--card-bg); border-color: var(--card-border); }
        }

        .card-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
        .card-right { text-align: right; flex-shrink: 0; }

        .player-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); background: #1e293b; }

        /* MOBILE STICKY FOOTER */
        .mobile-draft-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--accent); 
            padding: 12px 16px;
            padding-bottom: env(safe-area-inset-bottom, 12px);
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            will-change: transform;
        }
        
        .roster-drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 101; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .roster-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .roster-drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1e293b; border-top-left-radius: 20px; border-top-right-radius: 20px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 102; max-height: 80vh; display: flex; flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .roster-drawer.open { transform: translateY(0); }

        /* Mobile Navigation Menu */
        #mobile-menu {
            position: absolute; top: 100%; left: 0; right: 0;
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-in-out;
            z-index: 90;
        }
        #mobile-menu.open { max-height: 400px; }

        /* Tab Visibility - Forced Styles */
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; }
        #draft-team-view.active { display: flex !important; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loading-overlay { background: rgba(2, 6, 23, 0.9); z-index: 9999; }
        .player-fallback-initial {
            display: none; background: #334155; color: #94a3b8;
            align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;
        }
        .player-fallback-initial.is-visible { display: flex; }
        .sub-header-hidden { display: none !important; }
        .hidden-section .player-grid { display: none; }
        .hidden-section .collapse-icon { transform: rotate(-90deg); }

    </style>
</head>
<body class="antialiased selection:bg-brand selection:text-black">

    <header class="glass-header sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center shadow-[0_0_15px_var(--accent-glow)]">
                        <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h1 class="text-lg font-black tracking-tight text-white uppercase italic">
                        Hurd <span class="text-brand">Pool</span>
                    </h1>
                </div>

                <div class="hidden xl:flex items-center gap-6">
                    <nav class="flex space-x-6" id="desktop-nav">
                        <a href="#draft-team-view" id="nav-draft-team" class="nav-link active text-xs font-bold uppercase tracking-widest text-brand hover:text-white">Draft</a>
                        <a href="#player-scores-view" id="nav-player-scores" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white">Scores</a>
                        <a href="#standings-view" id="nav-standings" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white">Standings</a>
                        <a href="#rules-view" id="nav-rules" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white">Rules</a>
                        <a href="admin.html" id="nav-admin" class="hidden text-yellow-400 text-xs font-bold uppercase border border-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/10">Admin</a>
                    </nav>
                    <div id="user-auth-section" class="flex items-center">
                        <a href="login.html" id="login-button" class="bg-white text-black hover:bg-gray-200 px-4 py-1.5 rounded text-xs font-bold transition-colors uppercase">Sign In</a>
                        <div id="user-profile-section" class="hidden items-center gap-4">
                            <a href="my-teams.html" id="user-email-link" class="text-xs font-bold text-gray-400 hover:text-brand transition-colors uppercase flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-surface-200 flex items-center justify-center">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <span id="user-email-display" class="hidden lg:inline"></span>
                            </a>
                            <button id="logout-button" class="text-xs font-bold text-gray-500 hover:text-white transition-colors uppercase">Logout</button>
                        </div>
                    </div>
                </div>
                
                <div class="xl:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-white p-2 hover:text-brand focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="mobile-menu">
            <nav class="flex flex-col p-4 space-y-4">
                <a href="#draft-team-view" class="mobile-nav-link text-sm font-bold uppercase tracking-widest text-brand block py-2 border-b border-white/10">Draft</a>
                <a href="#player-scores-view" class="mobile-nav-link text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-white block py-2 border-b border-white/10">Scores</a>
                <a href="#standings-view" class="mobile-nav-link text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-white block py-2 border-b border-white/10">Standings</a>
                <a href="#rules-view" class="mobile-nav-link text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-white block py-2 border-b border-white/10">Rules</a>
                <a href="my-teams.html" class="text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-white block py-2 border-b border-white/10">My Teams</a>
                <a href="admin.html" id="mobile-nav-admin" class="hidden text-yellow-400 text-sm font-bold uppercase block py-2">Admin Panel</a>
            </nav>
        </div>
    </header>

    <nav id="sub-header" class="sticky top-16 z-30 bg-surface-900/95 backdrop-blur border-b border-white/5 shadow-lg"></nav>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <div id="draft-team-view" class="tab-content active flex flex-col xl:flex-row gap-8">
            <div id="player-pool-container" class="w-full xl:w-3/4 space-y-8" role="region" aria-label="Available players"></div>
            <aside class="hidden xl:block w-1/4 space-y-6 sticky top-32 self-start">
                <div class="glass-panel rounded-xl p-6 shadow-2xl">
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-xs font-bold uppercase text-gray-400 tracking-widest">Salary Cap</h3>
                            <span class="text-2xl font-bold text-white font-mono tracking-tight" id="total-salary-cap">$38.5M</span>
                        </div>
                        <div class="relative h-2 bg-surface-800 rounded-full overflow-hidden">
                            <div id="salary-progress-bar" class="absolute top-0 left-0 h-full bg-brand shadow-[0_0_10px_var(--accent)] rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs font-mono">
                            <span class="text-gray-500">SPENT: <span id="spent-amount" class="text-white">$0.0M</span></span>
                            <span class="text-brand">REM: <span id="remaining-salary" class="font-bold">$38.5M</span></span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5">
                            <h3 class="text-xs font-bold uppercase text-gray-400 tracking-widest">Your Roster</h3>
                            <span class="bg-surface-800 px-2 py-0.5 rounded text-xs font-bold text-white"><span id="roster-count">0</span>/10</span>
                        </div>
                        <div id="roster-slots-container" class="space-y-2"></div>
                    </div>
                    <div class="mt-8">
                        <button id="submit-team-button" disabled class="w-full bg-brand hover:bg-brand-dark text-black font-black text-lg py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all uppercase tracking-wide">Submit Team</button>
                        <p id="submit-team-message" class="text-xs text-center mt-2 text-gray-500"></p>
                    </div>
                </div>
            </aside>
        </div>

        <div id="player-scores-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">Player <span class="text-brand">Scores</span></h2>
            <div id="player-scores-list" class="space-y-8"></div>
        </div>

        <div id="standings-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">League <span class="text-brand">Standings</span></h2>
            <div class="overflow-x-auto rounded-lg border border-white/5">
                <table id="standings-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-surface-800"><tr><th class="px-6 py-4">Rank</th><th class="px-6 py-4">Team / User</th><th class="px-6 py-4 text-right">Total Points</th></tr></thead>
                    <tbody class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>

        <div id="rules-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">Pool <span class="text-brand">Rules</span></h2>
            <div class="grid md:grid-cols-2 gap-8 text-gray-300 text-sm">
                <div class="bg-surface-800/50 p-6 rounded-lg border border-white/5">
                    <h3 class="text-lg font-bold text-brand mb-4 flex items-center gap-2">Draft Rules</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start gap-2"><span class="text-brand">•</span><span>Salary Cap: <strong class="text-white">$38.5M</strong></span></li>
                        <li class="flex items-start gap-2"><span class="text-brand">•</span><span>Roster Size: <strong class="text-white">10 Players</strong></span></li>
                        <li class="flex items-start gap-2"><span class="text-brand">•</span><span>Max <strong class="text-white">3 players</strong> per NFL team.</span></li>
                        <li class="flex items-start gap-2"><span class="text-brand">•</span><span>Limit: <strong class="text-white">4 Entries</strong> per user.</span></li>
                    </ul>
                </div>
                <div class="bg-surface-800/50 p-6 rounded-lg border border-white/5">
                    <h3 class="text-lg font-bold text-brand mb-4 flex items-center gap-2">Roster Positions</h3>
                    <ul class="grid grid-cols-2 gap-3">
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">1 Quarterback</li>
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">3 Running Backs</li>
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">3 Wide Receivers</li>
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">1 Flex (RB/WR/TE)</li>
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">1 Kicker</li>
                        <li class="bg-surface-900 p-2 rounded text-center border border-white/5">1 Defense (D/ST)</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <div id="mobile-draft-footer" class="mobile-draft-footer xl:hidden">
        <div class="flex flex-col">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Remaining Salary</span>
            <span id="mobile-remaining-salary" class="text-lg font-mono font-bold text-brand">$38.5M</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end mr-2">
                 <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Roster</span>
                 <span class="text-sm font-bold text-white"><span id="mobile-roster-count">0</span>/10</span>
            </div>
            <button id="open-roster-drawer" class="bg-surface-800 border border-white/20 text-white hover:bg-surface-700 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide shadow-lg">My Team</button>
            <button id="mobile-submit-btn" disabled class="bg-brand text-black px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide shadow-[0_0_10px_var(--accent-glow)] disabled:opacity-50 disabled:shadow-none">Submit</button>
        </div>
    </div>

    <div id="roster-drawer-overlay" class="roster-drawer-overlay xl:hidden"></div>
    <div id="roster-drawer" class="roster-drawer xl:hidden">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-surface-900">
            <h3 class="text-sm font-black text-white uppercase tracking-wider">Your Lineup</h3>
            <button id="close-roster-drawer" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
        </div>
        <div id="mobile-roster-container" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        <div class="p-4 bg-surface-900 border-t border-white/10">
            <div class="flex justify-between text-xs mb-1 font-bold text-gray-400">
                <span>Cap Usage</span>
                <span id="mobile-drawer-spent">$0.0M / $38.5M</span>
            </div>
            <div class="h-2 bg-surface-800 rounded-full overflow-hidden">
                <div id="mobile-drawer-progress" class="h-full bg-brand" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-surface-800 border border-white/10 rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 id="alert-modal-title" class="text-lg font-bold text-white mb-2">Notice</h3>
            <p id="alert-modal-message" class="text-gray-400 mb-6 text-sm"></p>
            <button id="alert-modal-close-btn" class="w-full bg-surface-700 hover:bg-surface-600 text-white font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <div id="prompt-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-surface-800 border border-brand/30 rounded-xl p-6 max-w-md w-full shadow-2xl">
            <h3 id="prompt-modal-title" class="text-xl font-black text-white mb-2 italic uppercase">Name Team</h3>
            <p id="prompt-modal-message" class="text-gray-400 mb-4 text-sm">Enter a name for your entry.</p>
            <input type="text" id="prompt-modal-input" class="w-full bg-surface-900 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-brand mb-2" placeholder="e.g. Mahomes Depot">
            <div id="prompt-modal-error" class="hidden text-red-500 text-xs mb-4 font-bold"></div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="prompt-modal-cancel-btn" class="px-4 py-2 rounded-lg font-bold text-gray-400 hover:text-white text-sm">Cancel</button>
                <button id="prompt-modal-confirm-btn" class="bg-brand text-black px-6 py-2 rounded-lg font-bold text-sm">Submit</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex flex-col items-center justify-center gap-4">
        <div class="w-10 h-10 border-4 border-surface-700 border-t-brand rounded-full animate-spin"></div>
    </div>

    <script type="module">
        import { getSupabaseClient, checkIsAdmin, clearAdminCache } from './scripts/supabaseClient.js';

        let supabaseClient;
        try { supabaseClient = getSupabaseClient(); } catch (e) { console.error(e); }

        let uiElements = {};
        const CONSTANTS = { INITIAL_SALARY_CAP: 38500000, MAX_PLAYERS_PER_TEAM: 3, ROSTER_SIZE: 10, MAX_ENTRIES_PER_USER: 4, DEBOUNCE_DELAY: 50 };
        const appState = { currentUser: null, currentSession: null, currentSalarySpent: 0, draftedPlayers: {}, roster: { QB: null, RB1: null, RB2: null, RB3: null, WR1: null, WR2: null, WR3: null, FLEX: null, DST: null, K: null }, teamCounts: {}, playersById: {}, allPlayersByPosition: {}, editingTeamId: null };
        const rosterSlotConfig = { QB: { count: 1, display: "QB", slots: ["QB"] }, RB: { count: 3, display: "RB", slots: ["RB1", "RB2", "RB3"] }, WR: { count: 3, display: "WR", slots: ["WR1", "WR2", "WR3"] }, FLEX: { count: 1, display: "FLEX", slots: ["FLEX"] }, DST: { count: 1, display: "D/ST", slots: ["DST"] }, K: { count: 1, display: "K", slots: ["K"]}, TE: { count: 0, display: "TE", slots: [] } };
        let updateUITimeout = null;

        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        function toggleMobileMenu() { mobileMenu.classList.toggle('open'); }
        if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);

        document.addEventListener('DOMContentLoaded', () => {
            uiElements = {
                playerPoolContainer: document.getElementById('player-pool-container'),
                rosterSlotsContainer: document.getElementById('roster-slots-container'),
                remainingSalaryEl: document.getElementById('remaining-salary'),
                salaryProgressBar: document.getElementById('salary-progress-bar'),
                rosterCountEl: document.getElementById('roster-count'),
                submitTeamButton: document.getElementById('submit-team-button'),
                submitTeamMessage: document.getElementById('submit-team-message'),
                navLinks: document.querySelectorAll('.nav-link'),
                tabContents: document.querySelectorAll('.tab-content'),
                alertModal: document.getElementById('alert-modal'),
                subHeader: document.getElementById('sub-header'),
                loadingOverlay: document.getElementById('loading-overlay'),
                playerScoresList: document.getElementById('player-scores-list'),
                standingsTableBody: document.querySelector('#standings-table tbody'),
                userAuthSection: document.getElementById('user-auth-section'),
                loginButton: document.getElementById('login-button'),
                userProfileSection: document.getElementById('user-profile-section'),
                userEmailDisplay: document.getElementById('user-email-display'),
                logoutButton: document.getElementById('logout-button'),
                promptModal: document.getElementById('prompt-modal'),
                adminNavButton: document.getElementById('nav-admin')
            };
            showLoadingState(); checkUser(); setupEventListeners();
        });

        function setupEventListeners() {
            uiElements.playerPoolContainer?.addEventListener('click', handlePlayerPoolClick);
            uiElements.navLinks.forEach(link => link.addEventListener('click', handleNavLinkClick));
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    if (href.includes('.html')) { window.location.href = href; return; }
                    handleNavSwitch(href.substring(1));
                    toggleMobileMenu();
                });
            });
            document.getElementById('alert-modal-close-btn')?.addEventListener('click', () => uiElements.alertModal?.classList.add('hidden'));
            document.getElementById('prompt-modal-cancel-btn')?.addEventListener('click', hidePromptModal);
            document.getElementById('prompt-modal-confirm-btn')?.addEventListener('click', handleConfirmSubmission);
            document.getElementById('mobile-submit-btn')?.addEventListener('click', handleSubmitTeamClick);
            uiElements.logoutButton?.addEventListener('click', handleLogout);
            uiElements.submitTeamButton?.addEventListener('click', handleSubmitTeamClick);
        }

        function handleNavLinkClick(e) {
            e.preventDefault();
            const href = e.currentTarget.getAttribute('href');
            if (href.includes('.html')) { window.location.href = href; return; }
            handleNavSwitch(href.substring(1));
        }

        function handleNavSwitch(targetId) {
            if(!targetId) return;
            uiElements.navLinks.forEach(nav => { nav.classList.remove('active', 'text-brand'); nav.classList.add('text-gray-400'); });
            const match = document.querySelector(`#desktop-nav a[href="#${targetId}"]`);
            if (match) { match.classList.add('active', 'text-brand'); match.classList.remove('text-gray-400'); }
            
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('text-brand', 'text-white'); link.classList.add('text-gray-400');
                if(link.getAttribute('href') === '#' + targetId) { link.classList.add('text-brand'); link.classList.remove('text-gray-400'); }
            });

            uiElements.tabContents.forEach(c => c.classList.toggle('active', c.id === targetId));
            updateSubHeaderVisibility(targetId);
            if(targetId === 'player-scores-view') renderPlayerScoresTab();
            if(targetId === 'standings-view') fetchAndRenderStandings();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateSubHeaderVisibility(tid) {
            if(!uiElements.subHeader) return;
            if (tid === 'draft-team-view') uiElements.subHeader.classList.remove('sub-header-hidden');
            else uiElements.subHeader.classList.add('sub-header-hidden');
        }

        function handleSubmitTeamClick() {
            if (Object.keys(appState.draftedPlayers).length !== CONSTANTS.ROSTER_SIZE) { showAlertModal("Roster Incomplete", "You must draft 10 players."); return; }
            if (appState.editingTeamId) { handleConfirmSubmission(); } else { showPromptModal(); }
        }

        async function handleConfirmSubmission() {
            const n = document.getElementById('prompt-modal-input').value.trim();
            if (!appState.editingTeamId && !n) { document.getElementById('prompt-modal-error').textContent='Required'; document.getElementById('prompt-modal-error').classList.remove('hidden'); return; }
            showLoadingState(); hidePromptModal();
            try {
                if (!appState.editingTeamId) {
                    const { count } = await supabaseClient.from('user_teams').select('*', { count: 'exact', head: true }).eq('user_id', appState.currentUser.id);
                    if (count >= CONSTANTS.MAX_ENTRIES_PER_USER) throw new Error('Limit reached');
                    const { data, error } = await supabaseClient.from('user_teams').insert({ user_id: appState.currentUser.id, team_name: n }).select('id').single(); 
                    if (error) throw error; appState.editingTeamId = data.id; 
                }
                const ps = Object.keys(appState.roster).filter(k => appState.roster[k]).map(k => ({ team_id: appState.editingTeamId, player_id: appState.roster[k].id, roster_slot: k }));
                await supabaseClient.from('team_players').delete().eq('team_id', appState.editingTeamId);
                await supabaseClient.from('team_players').insert(ps);
                showAlertModal("Success!", "Team Saved");
                if (window.location.search.includes('edit_team_id')) setTimeout(() => window.location.href = "my-teams.html", 1500); else resetDraftState();
            } catch (e) { showAlertModal("Error", e.message); } finally { hideLoadingState(); }
        }

        async function checkUser() {
            if (!supabaseClient) { hideLoadingState(); return; }
            try {
                const { data, error } = await supabaseClient.auth.getSession();
                if (error || !data.session) { window.location.href = "login.html"; } 
                else {
                    appState.currentUser = data.session.user; appState.currentSession = data.session;
                    updateAuthUI(true, data.session.user.email); checkAdminStatus();
                    const urlParams = new URLSearchParams(window.location.search);
                    const teamIdToEdit = urlParams.get('edit_team_id');
                    await fetchPlayersAndScores(); 
                    if (teamIdToEdit) await loadTeamForEditing(teamIdToEdit); else hideLoadingState();
                    // Initial Render Calls
                    renderPlayerScoresTab(); 
                    fetchAndRenderStandings(); 
                }
            } catch(e) { console.error(e); hideLoadingState(); }
        }
        
        async function checkAdminStatus() { const isAdmin = await checkIsAdmin(); if (isAdmin) { uiElements.adminNavButton?.classList.remove('hidden'); document.getElementById('mobile-nav-admin')?.classList.remove('hidden'); } }
        function updateAuthUI(loggedIn, email) { if(loggedIn) { uiElements.loginButton.classList.add('hidden'); uiElements.userProfileSection.classList.remove('hidden'); uiElements.userProfileSection.style.display='flex'; uiElements.userEmailDisplay.textContent=email; } }
        async function handleLogout() { showLoadingState(); clearAdminCache(); await supabaseClient.auth.signOut(); window.location.href="login.html"; }
        
        async function fetchPlayersAndScores() {
            try {
                const [pRes, sRes] = await Promise.all([
                    supabaseClient.from('players').select('*'), 
                    supabaseClient.from('player_scores').select('*')
                ]);
                let ownershipMap = {}; try { const r = await supabaseClient.rpc('get_player_ownership'); if(r.data) r.data.forEach(o => ownershipMap[o.player_id] = o.percent); } catch(e){}
                const scoresMap = {}; (sRes.data||[]).forEach(s => { if(!scoresMap[s.player_id]) scoresMap[s.player_id] = { WC:0, DIV:0, CONF:0, SB:0, Total:0 }; scoresMap[s.player_id][s.playoff_round] = s.points; scoresMap[s.player_id].Total += s.points; });
                appState.allPlayersByPosition = { QB: [], RB: [], WR: [], TE: [], DST: [], K: [] };
                pRes.data.forEach(p => {
                    const s = scoresMap[p.id] || { WC:0, DIV:0, CONF:0, SB:0, Total:0 };
                    const player = { ...p, imageUrl: p.image_url, stats: s, ownership: ownershipMap[p.id] || 0, totalPoints: s.Total };
                    if (appState.allPlayersByPosition[player.position]) { appState.allPlayersByPosition[player.position].push(player); appState.playersById[player.id] = player; }
                });
                initializeUI();
            } catch(e) { console.error(e); }
        }

        async function loadTeamForEditing(teamId) {
            showLoadingState();
            try {
                const { data } = await supabaseClient.from('user_teams').select(`id, team_name, user_id, team_players(roster_slot, players(id))`).eq('id', teamId).single();
                resetDraftState(); appState.editingTeamId = data.id;
                data.team_players.forEach(tp => { const p = appState.playersById[tp.players.id]; if(p) { appState.roster[tp.roster_slot]=p; appState.draftedPlayers[p.id]=p; appState.currentSalarySpent+=p.salary; appState.teamCounts[p.team]=(appState.teamCounts[p.team]||0)+1; } });
                uiElements.submitTeamButton.textContent="Update Team"; document.getElementById('mobile-submit-btn').textContent="Update"; triggerUpdateAllUI();
            } catch(e) { window.location.href="index.html"; } finally { hideLoadingState(); }
        }

        function initializeUI() { renderPlayerPool(); renderRosterSlots(); renderSubHeader(); triggerUpdateAllUI(); updateSubHeaderVisibility('draft-team-view'); }
        function triggerUpdateAllUI() { if (updateUITimeout) clearTimeout(updateUITimeout); updateUITimeout = setTimeout(() => { updateSalaryUI(); updateRosterCount(); renderRosterSlots(); updatePlayerAvailabilityInPool(); checkRosterFull(); }, 50); }
        function updateSalaryUI() { 
            const rem=CONSTANTS.INITIAL_SALARY_CAP-appState.currentSalarySpent; const spent=appState.currentSalarySpent; const fmt=formatToMillions(rem);
            if(uiElements.remainingSalaryEl) uiElements.remainingSalaryEl.textContent=fmt; document.getElementById('spent-amount').textContent=formatToMillions(spent); document.getElementById('mobile-remaining-salary').textContent=fmt; document.getElementById('mobile-drawer-spent').textContent=`${formatToMillions(spent)} / $38.5M`;
            const pct=(spent/CONSTANTS.INITIAL_SALARY_CAP)*100; if(uiElements.salaryProgressBar) uiElements.salaryProgressBar.style.width=`${Math.min(pct,100)}%`; document.getElementById('mobile-drawer-progress').style.width=`${Math.min(pct,100)}%`;
        }
        function updateRosterCount() { const c=Object.keys(appState.draftedPlayers).length; uiElements.rosterCountEl.textContent=c; document.getElementById('mobile-roster-count').textContent=c; }
        function checkRosterFull() { const f=Object.keys(appState.draftedPlayers).length===CONSTANTS.ROSTER_SIZE; uiElements.submitTeamButton.disabled=!f; document.getElementById('mobile-submit-btn').disabled=!f; }
        function handlePlayerPoolClick(e) { const c=e.target.closest('.player-card'); const h=e.target.closest('.position-group h2'); if(h){h.parentElement.classList.toggle('hidden-section');return;} if(c&&!c.classList.contains('player-unavailable')&&!c.classList.contains('player-drafted')) draftPlayer(appState.playersById[c.dataset.playerId],c); }
        function draftPlayer(p,c) { 
            if(appState.currentSalarySpent+p.salary>CONSTANTS.INITIAL_SALARY_CAP){showAlertModal('Cap Exceeded','Not enough salary.');return;}
            if((appState.teamCounts[p.team]||0)>=CONSTANTS.MAX_PLAYERS_PER_TEAM){showAlertModal('Limit Reached','Too many from this team.');return;}
            const s=findAvailableSlot(p.position); if(!s){showAlertModal('Position Full','No slot.');return;}
            appState.roster[s]=p; appState.draftedPlayers[p.id]=p; appState.currentSalarySpent+=p.salary; appState.teamCounts[p.team]=(appState.teamCounts[p.team]||0)+1;
            c.classList.add('draft-flash'); setTimeout(()=>c.classList.remove('draft-flash'),500); triggerUpdateAllUI();
        }
        function findAvailableSlot(pos) { const s=rosterSlotConfig[pos]?.slots||[]; for(const k of s) if(!appState.roster[k]) return k; if(['RB','WR','TE'].includes(pos)&&!appState.roster.FLEX) return 'FLEX'; return null; }
        function removePlayer(id,s) { const p=appState.draftedPlayers[id]; if(!p)return; appState.currentSalarySpent-=p.salary; appState.teamCounts[p.team]--; if(appState.teamCounts[p.team]<=0) delete appState.teamCounts[p.team]; delete appState.draftedPlayers[id]; appState.roster[s]=null; triggerUpdateAllUI(); }
        function resetDraftState() { appState.currentSalarySpent=0; appState.draftedPlayers={}; appState.roster={QB:null,RB1:null,RB2:null,RB3:null,WR1:null,WR2:null,WR3:null,FLEX:null,DST:null,K:null}; appState.teamCounts={}; appState.editingTeamId=null; triggerUpdateAllUI(); }

        function renderPlayerPool() { 
            const c=uiElements.playerPoolContainer; if(!c)return; c.innerHTML=''; 
            ["QB","RB","WR","TE","DST","K"].forEach(k=>{ 
                const ps=appState.allPlayersByPosition[k]; if(ps?.length>0){ 
                    const s=document.createElement('section'); s.id=`section-${k}`; s.className='position-group mb-6'; 
                    s.innerHTML=`<h2 class="text-xl font-black text-white mb-3 flex items-center gap-3 uppercase italic tracking-tight sticky top-28 bg-surface-900/95 p-2 z-20 backdrop-blur cursor-pointer"><span>${k}</span><span class="h-px flex-grow bg-white/10"></span><svg class="collapse-icon w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></h2><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 player-grid transition-all"></div>`; 
                    const g=s.querySelector('.player-grid'); ps.sort((a,b)=>b.salary-a.salary).forEach(p=>g.appendChild(createPlayerCard(p))); c.appendChild(s); 
                } 
            }); 
        }

        function createPlayerCard(player) {
            if (!player || !player.id) return null;
            const card = document.createElement('div');
            card.className = 'player-card group';
            card.dataset.playerId = String(player.id);
            card.setAttribute('role', 'button');
            
            const leftDiv = document.createElement('div'); leftDiv.className = 'card-left';
            const imgContainer = document.createElement('div'); imgContainer.className = 'relative w-[42px] h-[42px] shrink-0';
            const img = document.createElement('img');
            img.src = player.image_url || (player.position === 'DST' ? `https://a.espncdn.com/i/teamlogos/nfl/500/${player.espn_id||'0'}.png` : `https://a.espncdn.com/i/headshots/nfl/players/full/${player.espn_id||'0'}.png`);
            img.className = 'player-avatar w-full h-full'; img.loading = 'lazy';
            const fallback = document.createElement('div'); fallback.className = 'player-fallback-initial player-avatar absolute inset-0 w-full h-full'; fallback.textContent = (player.name?.charAt(0) || '?');
            img.onerror = () => { img.style.display='none'; fallback.classList.add('is-visible'); }; img.onload = () => { fallback.classList.remove('is-visible'); };
            imgContainer.appendChild(img); imgContainer.appendChild(fallback);
            
            const infoDiv = document.createElement('div'); infoDiv.className = 'flex flex-col min-w-0';
            const nameEl = document.createElement('span'); nameEl.className = 'text-sm font-bold text-white leading-tight group-hover:text-brand transition-colors truncate'; nameEl.textContent = player.name;
            const metaEl = document.createElement('span'); metaEl.className = 'text-[10px] font-bold text-gray-500 uppercase tracking-wide mt-0.5 truncate'; metaEl.textContent = `${player.position} • ${player.team}`;
            infoDiv.appendChild(nameEl); infoDiv.appendChild(metaEl);
            leftDiv.appendChild(imgContainer); leftDiv.appendChild(infoDiv);
            
            const rightDiv = document.createElement('div'); rightDiv.className = 'card-right';
            const salaryEl = document.createElement('div'); salaryEl.className = 'text-sm font-mono font-bold text-brand'; salaryEl.textContent = formatToMillions(player.salary);
            const addIcon = document.createElement('div'); addIcon.className = 'text-[10px] text-gray-500 hidden group-hover:block mt-1'; addIcon.textContent = 'ADD +';
            rightDiv.appendChild(salaryEl); rightDiv.appendChild(addIcon);
            card.appendChild(leftDiv); card.appendChild(rightDiv);
            return card;
        }

        function renderRosterSlots() {
            const desktopContainer = uiElements.rosterSlotsContainer;
            const mobileContainer = document.getElementById('mobile-roster-container');
            if (desktopContainer) desktopContainer.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';
            const slotOrder = ["QB", "RB1", "RB2", "RB3", "WR1", "WR2", "WR3", "FLEX", "DST", "K"];
            const createSlotEl = (slotKey, isMobile) => {
                const playerInSlot = appState.roster[slotKey];
                const slotDiv = document.createElement('div');
                slotDiv.className = isMobile ? 'flex justify-between items-center p-3 bg-surface-800 rounded-lg border border-white/5' : 'flex justify-between items-center p-2 bg-surface-800/50 border border-white/5 rounded hover:bg-surface-800 group transition-colors';
                if (playerInSlot) {
                    const left = document.createElement('div'); left.className = 'flex items-center gap-3';
                    const label = document.createElement('span'); label.className = 'text-[10px] font-bold text-gray-500 uppercase w-8'; label.textContent = slotKey.replace(/\d/, ''); 
                    const name = document.createElement('span'); name.className = 'font-bold text-sm text-white truncate max-w-[120px]'; name.textContent = playerInSlot.name;
                    left.appendChild(label); left.appendChild(name);
                    const right = document.createElement('div'); right.className = 'flex items-center gap-3';
                    const sal = document.createElement('span'); sal.className = 'font-mono text-xs text-brand'; sal.textContent = formatToMillions(playerInSlot.salary);
                    const removeBtn = document.createElement('button'); removeBtn.className = 'text-gray-500 hover:text-red-500 p-1'; removeBtn.innerHTML = '✕';
                    removeBtn.onclick = (e) => { e.stopPropagation(); removePlayer(playerInSlot.id, slotKey); };
                    right.appendChild(sal); right.appendChild(removeBtn);
                    slotDiv.appendChild(left); slotDiv.appendChild(right);
                    if(!isMobile) slotDiv.classList.add('border-brand/20'); 
                } else {
                    const label = document.createElement('span'); label.className = 'text-[10px] font-bold text-gray-600 uppercase w-8'; label.textContent = slotKey.replace(/\d/, '');
                    const emptyText = document.createElement('span'); emptyText.className = 'text-xs text-gray-700 italic'; emptyText.textContent = 'Empty';
                    slotDiv.appendChild(label); slotDiv.appendChild(emptyText);
                }
                return slotDiv;
            };
            slotOrder.forEach(slotKey => {
                if (desktopContainer) desktopContainer.appendChild(createSlotEl(slotKey, false));
                if (mobileContainer) mobileContainer.appendChild(createSlotEl(slotKey, true));
            });
        }

        function renderPlayerScoresTab() {
            const container = uiElements.playerScoresList; if(!container) return; container.innerHTML = '';
            ["QB", "RB", "WR", "TE", "DST", "K"].forEach(pos => {
                const players = appState.allPlayersByPosition[pos]; if(!players?.length) return;
                const wrapper = document.createElement('div'); wrapper.className = 'glass-panel p-4 md:p-6 rounded-xl mb-8';
                wrapper.innerHTML = `<h3 class="text-lg font-black text-brand mb-4 border-b border-white/5 pb-2">${pos}</h3>`;
                const table = document.createElement('table'); table.className = 'w-full text-sm text-left text-gray-400';
                table.innerHTML = `
                    <thead class="text-xs uppercase text-gray-500">
                        <tr>
                            <th class="py-2">Player</th><th class="text-center">Own %</th>
                            <th class="text-center">WC</th><th class="text-center">DIV</th>
                            <th class="text-center">CONF</th><th class="text-center">SB</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        ${players.sort((a,b)=>b.totalPoints-a.totalPoints).map(p => `
                            <tr>
                                <td class="py-2 text-white font-medium text-xs md:text-sm">${p.name} <span class="text-gray-600 ml-1 text-[10px]">${p.team}</span></td>
                                <td class="text-center text-xs font-mono ${p.ownership>25?'text-brand':'text-gray-500'}">${p.ownership}%</td>
                                <td class="text-center font-mono text-xs">${p.stats.WC||'-'}</td><td class="text-center font-mono text-xs">${p.stats.DIV||'-'}</td><td class="text-center font-mono text-xs">${p.stats.CONF||'-'}</td><td class="text-center font-mono text-xs">${p.stats.SB||'-'}</td><td class="text-right font-mono text-brand font-bold">${p.totalPoints.toFixed(1)}</td>
                            </tr>`).join('')}
                    </tbody>`;
                wrapper.appendChild(table); container.appendChild(wrapper);
            });
        }

        async function fetchAndRenderStandings() {
            const tbody = uiElements.standingsTableBody; tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500 animate-pulse">Updating...</td></tr>`;
            try {
                const { data } = await supabaseClient.rpc('get_standings');
                tbody.innerHTML = ''; if(!data?.length) { tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-600">No teams.</td></tr>`; return; }
                data.forEach((team, i) => {
                    const row = tbody.insertRow(); row.className = i < 3 ? 'bg-white/5' : '';
                    row.innerHTML = `<td class="px-6 py-4 font-mono font-bold ${i===0?'text-yellow-400':i===1?'text-gray-300':i===2?'text-orange-400':'text-gray-500'}">#${team.rank}</td><td class="px-6 py-4 font-bold text-white text-sm">${team.team_name}</td><td class="px-6 py-4 text-right font-mono font-bold text-brand">${team.total_points.toFixed(1)}</td>`;
                });
            } catch(e) {}
        }
        
        function formatToMillions(v) { if(typeof v!=='number'||isNaN(v))return'$0.0M'; return`$${(v/1000000).toFixed(1)}M`; }
        function showLoadingState(s=true) { document.getElementById('loading-overlay').style.display=s?'flex':'none'; }
        function hideLoadingState() { showLoadingState(false); }
        function showAlertModal(t,m) { document.getElementById('alert-modal-title').textContent=t; document.getElementById('alert-modal-message').textContent=m; document.getElementById('alert-modal').classList.remove('hidden'); }
        function showPromptModal() { document.getElementById('prompt-modal').classList.remove('hidden'); }
        function hidePromptModal() { document.getElementById('prompt-modal').classList.add('hidden'); }
    </script>
</body>
</html>
