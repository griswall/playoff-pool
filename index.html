<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hurd NFL Playoff Pool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        brand: { DEFAULT: '#00d084', dark: '#00a366' },
                        surface: { 800: '#0f172a', 900: '#020617' }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: #020617; 
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #020617 60%); 
            background-attachment: fixed; 
            color: #f8fafc; 
            min-height: 100vh; 
            padding-bottom: 120px; /* Mobile Footer Space */
        }
        /* Desktop (LG+): Kill the padding */
        @media (min-width: 1024px) { body { padding-bottom: 0; } }

        .glass-header { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* Nav Links */
        .nav-link { position: relative; transition: color 0.2s; cursor: pointer; }
        .nav-link.active { color: #00d084; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -21px; left: 0; width: 100%; height: 3px; background: #00d084; }

        /* Sticky Sub-Header */
        .sticky-sub-header { position: sticky; top: 64px; z-index: 40; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Cards */
        .player-card { display: flex; align-items: center; justify-content: space-between; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 0.75rem; cursor: pointer; position: relative; overflow: hidden; transform: translateZ(0); transition: all 0.2s; }
        @media(hover: hover) { .player-card:hover:not(.player-drafted):not(.player-unavailable) { border-color: #00d084; background: rgba(30, 41, 59, 0.9); } }
        .player-card.player-drafted { opacity: 0.5; filter: grayscale(100%); pointer-events: none; border-color: rgba(255,255,255,0.05); }
        .player-card.player-unavailable { opacity: 0.3; pointer-events: none; background: rgba(0,0,0,0.2); }
        .draft-flash { animation: flash 0.5s ease-out; }
        @keyframes flash { 0% { background-color: #00d084; } 100% { background-color: rgba(30, 41, 59, 0.6); } }

        .player-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #1e293b; }
        .player-fallback-initial { display: none; background: #334155; color: #94a3b8; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; }
        .player-fallback-initial.is-visible { display: flex; }

        /* Mobile Footer */
        .mobile-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); border-top: 1px solid #00d084; padding: 12px 16px; z-index: 100; padding-bottom: env(safe-area-inset-bottom, 12px); }
        
        /* Drawer */
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 101; display: none; }
        .drawer-overlay.open { display: block; }
        .drawer { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: transform 0.3s; z-index: 102; max-height: 80vh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .drawer.open { transform: translateY(0); }
        
        /* Mobile Menu */
        #mobile-menu { max-height: 0; overflow: hidden; transition: max-height 0.3s; background: rgba(2,6,23,0.98); position: absolute; width: 100%; top: 100%; left: 0; z-index: 90; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #mobile-menu.open { max-height: 400px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #draft-team-view.active { display: flex; flex-direction: column; }
        @media(min-width: 1024px) { #draft-team-view.active { flex-direction: row; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loading-overlay { position: fixed; inset: 0; background: #020617; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .sub-header-hidden { display: none !important; }
    </style>
</head>
<body class="antialiased selection:bg-brand selection:text-black">

    <div id="loading-overlay" class="loading-overlay">
        <div class="w-10 h-10 border-4 border-gray-700 border-t-[#00d084] rounded-full animate-spin"></div>
    </div>

    <header class="glass-header sticky top-0 z-50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between relative">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-[#00d084] to-[#00a366] flex items-center justify-center font-bold text-black">H</div>
                <h1 class="text-lg font-black text-white uppercase italic">Hurd <span class="text-[#00d084]">Pool</span></h1>
            </div>

            <nav class="hidden lg:flex gap-6">
                <a href="#draft-team-view" class="nav-link active text-xs font-bold uppercase tracking-widest text-[#00d084] py-5">Draft</a>
                <a href="#player-scores-view" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white py-5">Scores</a>
                <a href="#standings-view" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white py-5">Standings</a>
                <a href="#rules-view" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white py-5">Rules</a>
                <a href="my-teams.html" class="text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white py-5">My Teams</a>
                <a href="admin.html" id="nav-admin" class="hidden text-yellow-400 text-xs font-bold uppercase border border-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/10">Admin</a>
            </nav>

            <div class="flex items-center gap-4">
                <div id="user-auth-section" class="flex items-center">
                    <a href="login.html" id="login-button" class="bg-white text-black px-4 py-1.5 rounded text-xs font-bold uppercase">Sign In</a>
                    <div id="user-profile-section" class="hidden items-center gap-4">
                        <a href="my-teams.html" id="user-email-link" class="hidden lg:block text-xs font-bold text-gray-400 uppercase hover:text-[#00d084]">My Teams</a>
                        <button id="logout-button" class="text-xs font-bold text-gray-500 uppercase hover:text-white">Logout</button>
                    </div>
                </div>
                <button id="mobile-menu-btn" class="lg:hidden text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            </div>

            <div id="mobile-menu">
                <nav class="flex flex-col p-4 space-y-4">
                    <a href="#draft-team-view" class="mobile-nav-link text-sm font-bold uppercase text-[#00d084]">Draft</a>
                    <a href="#player-scores-view" class="mobile-nav-link text-sm font-bold uppercase text-gray-400">Scores</a>
                    <a href="#standings-view" class="mobile-nav-link text-sm font-bold uppercase text-gray-400">Standings</a>
                    <a href="#rules-view" class="mobile-nav-link text-sm font-bold uppercase text-gray-400">Rules</a>
                    <a href="my-teams.html" class="text-sm font-bold uppercase text-gray-400">My Teams</a>
                </nav>
            </div>
        </div>
    </header>

    <nav id="sub-header" class="sticky-sub-header">
        <div class="container mx-auto px-4 py-3 flex gap-2 overflow-x-auto no-scrollbar" id="pos-links">
            </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        
        <div id="draft-team-view" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-3/4 space-y-8 pb-24" id="player-pool-container"></div>

                <aside class="hidden lg:block w-1/4 space-y-6 sticky top-32 self-start">
                    <div class="glass-panel rounded-xl p-6 shadow-2xl">
                        <div class="mb-8">
                            <div class="flex justify-between items-end mb-2"><h3 class="text-xs font-bold text-gray-400 uppercase">Salary Cap</h3><span class="text-2xl font-bold text-white font-mono" id="salary-display">$38.5M</span></div>
                            <div class="h-2 bg-gray-800 rounded-full overflow-hidden"><div id="salary-bar" class="h-full bg-[#00d084] w-0 transition-all duration-500"></div></div>
                            <div class="flex justify-between mt-2 text-xs font-mono"><span class="text-gray-500">SPENT: <span id="spent-amount" class="text-white">$0.0M</span></span></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5"><h3 class="text-xs font-bold uppercase text-gray-400">Your Roster</h3><span class="bg-gray-800 px-2 py-0.5 rounded text-xs font-bold text-white"><span id="roster-count">0</span>/10</span></div>
                            <div id="roster-slots-container" class="space-y-2"></div>
                        </div>
                        <button id="submit-team-button" disabled class="w-full mt-6 bg-[#00d084] text-black font-bold py-3 rounded-lg disabled:opacity-50 transition-all uppercase">Submit Team</button>
                        <p id="submit-team-message" class="text-xs text-center mt-2 text-gray-500"></p>
                    </div>
                </aside>
            </div>
        </div>

        <div id="player-scores-view" class="tab-content">
            <div class="glass-panel rounded-xl p-6" id="player-scores-list"></div>
        </div>

        <div id="standings-view" class="tab-content">
            <div class="glass-panel rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6">Standings</h2>
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-900"><tr><th class="px-6 py-4">Rank</th><th class="px-6 py-4">Team</th><th class="px-6 py-4 text-right">Total Points</th></tr></thead>
                    <tbody id="standings-table-body" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
        </div>

        <div id="rules-view" class="tab-content">
            <div class="glass-panel rounded-xl p-6 text-gray-300 text-sm space-y-4">
                <h2 class="text-2xl font-bold text-white">Rules</h2>
                <ul class="list-disc pl-5 space-y-2">
                    <li>Salary Cap: <strong>$38.5M</strong></li>
                    <li>Roster: 1 QB, 3 RB, 3 WR, 1 TE/Flex, 1 K, 1 D/ST</li>
                    <li>Max 3 players per NFL team.</li>
                    <li>Max 4 entries per user.</li>
                </ul>
            </div>
        </div>
    </main>

    <div id="mobile-draft-footer" class="mobile-footer lg:hidden">
        <div class="flex flex-col"><span class="text-[10px] font-bold text-gray-400 uppercase">Remaining</span><span id="mobile-remaining-salary" class="text-lg font-mono font-bold text-[#00d084]">$38.5M</span></div>
        <div class="flex gap-3">
            <a href="my-teams.html" class="bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">My Teams</a>
            <button id="mobile-submit-btn" disabled class="bg-[#00d084] text-black px-4 py-2 rounded-lg text-xs font-bold uppercase disabled:opacity-50">Submit</button>
        </div>
    </div>

    <div id="roster-drawer-overlay" class="drawer-overlay"></div>
    <div id="roster-drawer" class="drawer">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-surface-900"><h3 class="text-sm font-black text-white uppercase">Your Lineup</h3><button id="close-drawer-btn" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
        <div id="mobile-roster-container" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        <div class="p-4 bg-surface-900 border-t border-white/10"><div class="flex justify-between text-xs mb-1 font-bold text-gray-400"><span>Cap Usage</span><span id="mobile-drawer-spent">$0.0M / $38.5M</span></div><div class="h-2 bg-surface-800 rounded-full overflow-hidden"><div id="mobile-drawer-progress" class="h-full bg-brand" style="width: 0%"></div></div></div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-surface-800 border border-white/10 rounded-xl p-6 max-w-sm w-full shadow-2xl"><h3 id="alert-modal-title" class="text-lg font-bold text-white mb-2">Notice</h3><p id="alert-modal-message" class="text-gray-400 mb-6 text-sm"></p><button id="alert-modal-close-btn" class="w-full bg-surface-700 hover:bg-surface-600 text-white font-bold py-3 rounded-lg">Close</button></div></div>
    <div id="prompt-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-surface-800 border border-brand/30 rounded-xl p-6 max-w-md w-full shadow-2xl"><h3 id="prompt-modal-title" class="text-xl font-black text-white mb-2 italic uppercase">Name Team</h3><p id="prompt-modal-message" class="text-gray-400 mb-4 text-sm">Enter a name for your entry.</p><input type="text" id="prompt-modal-input" class="w-full bg-surface-900 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-[#00d084] mb-2" placeholder="e.g. Mahomes Depot"><div id="prompt-modal-error" class="hidden text-red-500 text-xs mb-4 font-bold"></div><div class="flex justify-end gap-3 mt-4"><button id="prompt-modal-cancel-btn" class="px-4 py-2 rounded-lg font-bold text-gray-400 hover:text-white text-sm">Cancel</button><button id="prompt-modal-confirm-btn" class="bg-brand text-black px-6 py-2 rounded-lg font-bold text-sm">Submit</button></div></div></div>

    <script type="module">
        import { getSupabaseClient, checkIsAdmin, clearAdminCache } from './scripts/supabaseClient.js';
        
        let supabase;
        const STATE = {
            user: null,
            salaryCap: 38500000,
            spent: 0,
            roster: { QB: null, RB1: null, RB2: null, RB3: null, WR1: null, WR2: null, WR3: null, FLEX: null, DST: null, K: null },
            draftedIds: new Set(),
            teamCounts: {},
            players: {},
            byPos: { QB:[], RB:[], WR:[], TE:[], DST:[], K:[] },
            editingId: null
        };
        
        const SLOTS = ["QB", "RB1", "RB2", "RB3", "WR1", "WR2", "WR3", "FLEX", "DST", "K"];
        const SLOT_CONFIG = { QB:["QB"], RB:["RB1","RB2","RB3"], WR:["WR1","WR2","WR3"], TE:["FLEX"], K:["K"], DST:["DST"] };

        document.addEventListener('DOMContentLoaded', async () => {
            renderSubLinks(); // Render immediately
            try {
                supabase = getSupabaseClient();
                await checkUser();
            } catch(e) { 
                console.error(e); 
            }
            document.getElementById('loading-overlay').classList.add('hidden');
            setupListeners();
        });

        function setupListeners() {
            // Desktop Links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    switchTab(targetId);
                });
            });

            // Mobile Links
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    switchTab(targetId);
                    document.getElementById('mobile-menu').classList.remove('open');
                });
            });

            document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('mobile-menu').classList.toggle('open');
            
            // Drawer logic
            const openDrawer = () => {
                document.getElementById('roster-drawer').classList.add('open');
                document.getElementById('roster-drawer-overlay').classList.add('open');
            };
            const closeDrawer = () => {
                document.getElementById('roster-drawer').classList.remove('open');
                document.getElementById('roster-drawer-overlay').classList.remove('open');
            };

            // Mobile footer click (ignoring buttons)
            document.getElementById('mobile-draft-footer').onclick = (e) => {
                if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') openDrawer();
            };
            document.getElementById('close-drawer-btn').onclick = closeDrawer;
            document.getElementById('roster-drawer-overlay').onclick = closeDrawer;
            document.getElementById('open-roster-drawer').onclick = openDrawer;

            document.getElementById('submit-team-button').onclick = handleSubmit;
            document.getElementById('mobile-submit-btn').onclick = handleSubmit;
            document.getElementById('prompt-modal-cancel-btn').onclick = () => document.getElementById('prompt-modal').classList.add('hidden');
            document.getElementById('prompt-modal-confirm-btn').onclick = confirmSubmit;
            document.getElementById('alert-modal-close-btn').onclick = () => document.getElementById('alert-modal').classList.add('hidden');
            document.getElementById('logout-button').onclick = async () => { await supabase.auth.signOut(); window.location.href="login.html"; };
        }

        function switchTab(tabId) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            
            // Show target content
            document.getElementById(tabId + '-view').classList.add('active');
            
            // Update Nav Styling
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'text-[#00d084]'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.add('text-gray-400'));
            
            const activeLink = document.querySelector(`a[href="#${tabId}"].nav-link`);
            if(activeLink) {
                activeLink.classList.add('active', 'text-[#00d084]');
                activeLink.classList.remove('text-gray-400');
            }

            // Toggle Sub-Header & Mobile Footer
            const subHeader = document.getElementById('sub-header');
            const mobFooter = document.getElementById('mobile-draft-footer');
            
            if (tabId === 'draft-team') {
                subHeader.classList.remove('sub-header-hidden');
                mobFooter.classList.remove('hidden');
            } else {
                subHeader.classList.add('sub-header-hidden');
                mobFooter.classList.add('hidden');
            }

            if(tabId === 'player-scores') renderScores();
            if(tabId === 'standings') renderStandings();
            
            window.scrollTo(0,0);
        }

        function renderSubLinks() {
            const c = document.getElementById('pos-links');
            const positions = ["QB", "RB", "WR", "TE", "DST", "K"];
            c.innerHTML = positions.map(k => `<a href="#pos-${k}" class="flex-shrink-0 px-4 py-1.5 rounded-full text-[10px] font-bold uppercase border border-gray-700 bg-gray-900 text-gray-400 hover:text-white hover:border-[#00d084] transition-colors">${k}</a>`).join('');
        }

        async function checkUser() {
            const { data } = await supabase.auth.getSession();
            if (!data.session) { window.location.href = "login.html"; return; }
            
            STATE.user = data.session.user;
            document.getElementById('login-button').classList.add('hidden');
            document.getElementById('user-profile-section').classList.remove('hidden');
            document.getElementById('user-profile-section').style.display = 'flex';

            if (await checkIsAdmin()) document.getElementById('nav-admin').classList.remove('hidden');

            await loadData();
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('edit_team_id')) await loadTeam(params.get('edit_team_id'));
            
            // Force Draft Tab Visible Initially
            updateSubHeaderVisibility('draft-team-view');
        }

        async function loadData() {
            const [pRes, sRes] = await Promise.all([supabase.from('players').select('*'), supabase.from('player_scores').select('*')]);
            const scores = {};
            
            // Ownership Map (fail-safe)
            let ownershipMap = {};
            try { const r = await supabase.rpc('get_player_ownership'); if(r.data) r.data.forEach(o => ownershipMap[o.player_id] = o.percent); } catch(e){}

            (sRes.data||[]).forEach(s => {
                if(!scores[s.player_id]) scores[s.player_id] = { total:0, rounds:{} };
                scores[s.player_id].rounds[s.playoff_round] = s.points;
                scores[s.player_id].total += s.points;
            });

            pRes.data.forEach(p => {
                p.stats = scores[p.id] || { total:0, rounds:{} };
                p.ownership = ownershipMap[p.id] || 0;
                p.final_image = p.image_url || (p.position === 'DST' ? `https://a.espncdn.com/i/teamlogos/nfl/500/${p.espn_id}.png` : `https://a.espncdn.com/i/headshots/nfl/players/full/${p.espn_id}.png`);
                STATE.players[p.id] = p;
                if(STATE.byPos[p.position]) STATE.byPos[p.position].push(p);
            });

            renderDraftPool();
            renderRoster();
        }

        function renderDraftPool() {
            const c = document.getElementById('player-pool-container');
            c.innerHTML = '';
            ["QB", "RB", "WR", "TE", "DST", "K"].forEach(pos => {
                const list = STATE.byPos[pos];
                if(!list) return;
                const sec = document.createElement('div');
                sec.id = `pos-${pos}`;
                sec.innerHTML = `<h2 class="text-xl font-black text-white mb-4 flex items-center gap-4 sticky top-28 bg-[#020617]/95 py-2 z-20 backdrop-blur">${pos}<span class="h-px flex-grow bg-gray-800"></span></h2><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 player-grid"></div>`;
                const g = sec.querySelector('.player-grid');
                
                list.sort((a,b) => b.salary - a.salary).forEach(p => {
                    const el = document.createElement('div');
                    const isDrafted = STATE.draftedIds.has(p.id);
                    const isDisabled = isDrafted || (STATE.spent + p.salary > CONSTANTS.CAP);
                    el.className = `player-card ${isDrafted ? 'player-drafted' : ''} ${isDisabled && !isDrafted ? 'player-unavailable' : ''}`;
                    el.onclick = () => draftPlayer(p, el);
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="relative w-10 h-10 shrink-0">
                                <img src="${p.final_image}" class="player-avatar w-full h-full" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                <div class="player-fallback-initial player-avatar absolute inset-0 w-full h-full">${p.name.charAt(0)}</div>
                            </div>
                            <div class="min-w-0">
                                <div class="text-sm font-bold text-white truncate group-hover:text-[#00d084]">${p.name}</div>
                                <div class="text-[10px] font-bold text-gray-500 uppercase">${p.position} • ${p.team}</div>
                            </div>
                        </div>
                        <div class="text-right shrink-0"><div class="text-sm font-mono font-bold text-[#00d084]">$${(p.salary/1000000).toFixed(1)}M</div></div>
                    `;
                    g.appendChild(el);
                });
                c.appendChild(sec);
            });
        }

        function draftPlayer(p, el) {
            if(STATE.draftedIds.has(p.id)) return;
            if(STATE.spent + p.salary > CONSTANTS.CAP) { alert("Cap Exceeded"); return; }
            
            let slot = null;
            if (p.position === 'QB' && !STATE.roster.QB) slot = 'QB';
            else if (p.position === 'DST' && !STATE.roster.DST) slot = 'DST';
            else if (p.position === 'K' && !STATE.roster.K) slot = 'K';
            else if (["RB","WR","TE"].includes(p.position)) {
                // Specific Slots first
                const opts = SLOT_CONFIG[p.position] || [];
                for(let s of opts) if(!STATE.roster[s]) { slot=s; break; }
                // Then Flex
                if(!slot && !STATE.roster.FLEX) slot='FLEX';
            }

            if(slot) {
                STATE.roster[slot] = p;
                STATE.draftedIds.add(p.id);
                STATE.spent += p.salary;
                STATE.teamCounts[p.team] = (STATE.teamCounts[p.team]||0) + 1;
                el.classList.add('draft-flash');
                setTimeout(() => renderDraftPool(), 300); // Re-render to update gray-out state
                renderRoster();
            } else {
                alert("No slot available.");
            }
        }

        window.removePlayer = (slot) => {
            const p = STATE.roster[slot];
            if(!p) return;
            STATE.roster[slot] = null;
            STATE.draftedIds.delete(p.id);
            STATE.spent -= p.salary;
            STATE.teamCounts[p.team]--;
            renderRoster();
            renderDraftPool();
        }

        function renderRoster() {
            const html = SLOTS.map(slot => {
                const p = STATE.roster[slot];
                if(p) return `<div class="flex justify-between items-center p-2 bg-gray-800/50 border border-[#00d084]/30 rounded"><div class="flex items-center gap-2 overflow-hidden"><span class="text-[10px] font-bold text-gray-500 w-8 shrink-0">${slot.replace(/\d/,'')}</span><span class="text-xs font-bold text-white truncate max-w-[100px]">${p.name}</span></div><div class="flex items-center gap-2"><span class="font-mono text-xs text-[#00d084]">$${(p.salary/1000000).toFixed(1)}M</span><button onclick="removePlayer('${slot}')" class="text-gray-500 hover:text-red-500">✕</button></div></div>`;
                return `<div class="flex justify-between items-center p-2 bg-gray-800/30 border border-gray-800 rounded"><span class="text-[10px] font-bold text-gray-600 w-8">${slot.replace(/\d/,'')}</span><span class="text-xs text-gray-700 italic">Empty</span></div>`;
            }).join('');
            
            document.getElementById('roster-slots-container').innerHTML = html;
            document.getElementById('mobile-roster-container').innerHTML = html;
            
            const rem = CONSTANTS.CAP - STATE.spent;
            document.getElementById('salary-display').textContent = `$${(rem/1000000).toFixed(1)}M`;
            document.getElementById('mobile-remaining-salary').textContent = `$${(rem/1000000).toFixed(1)}M`;
            document.getElementById('salary-bar').style.width = `${(STATE.spent/CONSTANTS.CAP)*100}%`;
            document.getElementById('mobile-drawer-progress').style.width = `${(STATE.spent/CONSTANTS.CAP)*100}%`;
            
            const count = STATE.draftedIds.size;
            const valid = count === 10 && rem >= 0;
            document.getElementById('submit-team-button').disabled = !valid;
            document.getElementById('mobile-submit-btn').disabled = !valid;
            document.getElementById('roster-count').textContent = count;
            document.getElementById('mobile-roster-count').textContent = count;
        }

        function handleSubmit() { if(STATE.editingId) confirmSubmit(); else document.getElementById('prompt-modal').classList.remove('hidden'); }

        async function confirmSubmit() {
            const name = document.getElementById('prompt-modal-input').value;
            if(!STATE.editingId && !name) return;
            document.getElementById('prompt-modal').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                let tid = STATE.editingId;
                if(!tid) {
                    const {data, error} = await supabase.from('user_teams').insert({user_id: STATE.user.id, team_name: name}).select().single();
                    if(error) throw error;
                    tid = data.id;
                }
                const pl = [];
                Object.entries(STATE.roster).forEach(([k,v]) => { if(v) pl.push({team_id: tid, player_id: v.id, roster_slot: k}); });
                await supabase.from('team_players').delete().eq('team_id', tid);
                await supabase.from('team_players').insert(pl);
                alert("Team Saved!");
                window.location.href = "my-teams.html";
            } catch(e) { alert(e.message); document.getElementById('loading-overlay').classList.add('hidden'); }
        }

        async function loadTeam(tid) {
            const {data} = await supabase.from('user_teams').select(`id, team_name, team_players(roster_slot, players(*))`).eq('id',tid).single();
            STATE.editingId = data.id;
            data.team_players.forEach(tp => {
                const p = STATE.players[tp.players.id];
                if(p) { STATE.roster[tp.roster_slot] = p; STATE.draftedIds.add(p.id); STATE.spent += p.salary; STATE.teamCounts[p.team] = (STATE.teamCounts[p.team]||0)+1; }
            });
            document.getElementById('submit-team-button').textContent = "Update";
            document.getElementById('mobile-submit-btn').textContent = "Update";
            renderRoster();
        }

        function renderScores() {
            const c = document.getElementById('player-scores-list');
            c.innerHTML = `<h2 class="text-2xl font-bold text-white mb-6">Player Scores</h2>`;
            ["QB","RB","WR","TE","DST","K"].forEach(pos => {
                 const list = STATE.byPos[pos].sort((a,b)=>b.stats.total - a.stats.total);
                 let h = `<div class="mb-8"><h3 class="text-lg font-bold text-[#00d084] border-b border-gray-800 pb-2 mb-2">${pos}</h3><table class="w-full text-sm text-gray-400"><thead><tr class="text-xs uppercase"><th>Player</th><th class="text-center">Own %</th><th class="text-center">WC</th><th class="text-center">DIV</th><th class="text-center">CONF</th><th class="text-center">SB</th><th class="text-right">Total</th></tr></thead><tbody>`;
                 list.forEach(p => h+=`<tr><td class="py-2 text-white">${p.name}</td><td class="text-center text-xs font-mono ${p.ownership>25?'text-[#00d084]':'text-gray-600'}">${p.ownership}%</td><td class="text-center">${p.stats.rounds['WC']||'-'}</td><td class="text-center">${p.stats.rounds['DIV']||'-'}</td><td class="text-center">${p.stats.rounds['CONF']||'-'}</td><td class="text-center">${p.stats.rounds['SB']||'-'}</td><td class="text-right font-mono text-[#00d084]">${p.stats.total}</td></tr>`);
                 c.innerHTML += h + `</tbody></table></div>`;
            });
        }

        async function renderStandings() {
            const {data} = await supabase.rpc('get_standings');
            const tb = document.getElementById('standings-table-body');
            tb.innerHTML = '';
            if(data) data.forEach((t, i) => tb.innerHTML += `<tr><td class="px-6 py-4 font-mono text-[#00d084]">#${t.rank}</td><td class="px-6 py-4 text-white font-bold">${t.team_name}</td><td class="px-6 py-4 text-right font-mono text-[#00d084]">${t.total_points.toFixed(1)}</td></tr>`);
        }
        
        function updateSubHeaderVisibility(tid) {
            if(tid === 'draft-team') document.getElementById('sub-header').classList.remove('sub-header-hidden');
            else document.getElementById('sub-header').classList.add('sub-header-hidden');
        }
    </script>
</body>
</html>
