<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hurd NFL Playoff Pool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            DEFAULT: '#00d084',
                            dark: '#00a366',
                            glow: 'rgba(0, 208, 132, 0.5)'
                        },
                        surface: {
                            100: '#1e293b',
                            200: '#334155',
                            300: '#475569',
                            800: '#0f172a',
                            900: '#020617',
                        }
                    },
                    backgroundImage: {
                        'main-gradient': 'radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --accent: #00d084;
            --accent-glow: rgba(0, 208, 132, 0.4);
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
        }
        
        body {
            background: #020617;
            background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #020617 60%);
            background-attachment: fixed;
            color: #f8fafc;
            min-height: 100vh;
            padding-bottom: 80px; /* Space for mobile footer */
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
        }
        
        .glass-header {
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* COMPACT PLAYER CARD DESIGN */
        .player-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .player-card:hover:not(.player-unavailable):not(.player-drafted) {
            transform: translateX(4px);
            border-color: var(--accent);
            background: rgba(30, 41, 59, 0.95);
            box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Card Content Layout */
        .card-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; /* Prevents flex item from overflowing */ }
        .card-right { text-align: right; flex-shrink: 0; }

        /* Player Image */
        .player-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
            background: #1e293b;
        }

        /* States */
        .player-drafted { opacity: 0.5; filter: grayscale(100%); pointer-events: none; }
        .player-unavailable { opacity: 0.4; pointer-events: none; }
        
        .draft-flash {
            animation: flashHighlight 0.5s ease-out;
        }
        @keyframes flashHighlight {
            0% { background-color: var(--accent); border-color: var(--accent); }
            100% { background-color: var(--card-bg); border-color: var(--card-border); }
        }

        /* MOBILE STICKY FOOTER & DRAWER */
        .mobile-draft-footer {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border-top: 1px solid var(--accent);
            padding: 12px 16px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        
        /* Roster Drawer (Slide Up) */
        .roster-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 101;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .roster-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .roster-drawer {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #1e293b;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 102;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .roster-drawer.open { transform: translateY(0); }

        /* Tab Handling */
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .tab-content.active { display: block; opacity: 1; }
        #draft-team-view.active { display: flex; }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loading Overlay */
        .loading-overlay { background: rgba(2, 6, 23, 0.9); z-index: 9999; }

        /* Fallback Avatar */
        .player-fallback-initial {
            display: none;
            background: #334155;
            color: #94a3b8;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
        }
        .player-fallback-initial.is-visible { display: flex; }
        
        /* Sub Header Visibility */
        .sub-header-hidden { display: none !important; }

    </style>
</head>
<body class="antialiased selection:bg-brand selection:text-black">

    <header class="glass-header sticky top-0 z-40 transition-all duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gradient-to-br from-brand to-brand-dark flex items-center justify-center shadow-[0_0_15px_var(--accent-glow)]">
                        <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h1 class="text-lg font-black tracking-tight text-white uppercase italic">
                        Hurd <span class="text-brand">Pool</span>
                    </h1>
                </div>

                <div class="hidden md:flex items-center gap-6">
                    <nav class="flex space-x-6">
                        <a href="#draft-team-view" id="nav-draft-team" class="nav-link active text-xs font-bold uppercase tracking-widest text-brand hover:text-white transition-colors">Draft</a>
                        <a href="#player-scores-view" id="nav-player-scores" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors">Scores</a>
                        <a href="#standings-view" id="nav-standings" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors">Standings</a>
                        <a href="#rules-view" id="nav-rules" class="nav-link text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors">Rules</a>
                        <a href="admin.html" id="nav-admin" class="hidden text-yellow-400 text-xs font-bold uppercase border border-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/10">Admin</a>
                    </nav>
                    
                    <div id="user-auth-section" class="flex items-center">
                        <a href="login.html" id="login-button" class="bg-white text-black hover:bg-gray-200 px-4 py-1.5 rounded text-xs font-bold transition-colors uppercase">Sign In</a>
                        
                        <div id="user-profile-section" class="hidden items-center gap-4">
                            <a href="my-teams.html" id="user-email-link" class="text-xs font-bold text-gray-400 hover:text-brand transition-colors uppercase flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-surface-200 flex items-center justify-center">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <span id="user-email-display" class="hidden lg:inline"></span>
                            </a>
                            <button id="logout-button" class="text-xs font-bold text-gray-500 hover:text-white transition-colors uppercase">Logout</button>
                        </div>
                    </div>
                </div>
                
                <div class="md:hidden flex items-center">
                    <a href="my-teams.html" class="text-xs font-bold text-brand uppercase border border-brand/30 px-2 py-1 rounded">My Teams</a>
                </div>
            </div>
        </div>
    </header>

    <nav id="sub-header" class="sticky top-16 z-30 bg-surface-900/95 backdrop-blur border-b border-white/5 shadow-lg"></nav>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <div id="draft-team-view" class="tab-content active flex-col xl:flex-row gap-8">
            
            <div id="player-pool-container" class="w-full xl:w-3/4 space-y-8 pb-24" role="region" aria-label="Available players">
                </div>

            <aside class="hidden xl:block w-1/4 space-y-6 sticky top-32 self-start">
                <div class="glass-panel rounded-xl p-6 shadow-2xl">
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-xs font-bold uppercase text-gray-400 tracking-widest">Salary Cap</h3>
                            <span class="text-2xl font-bold text-white font-mono tracking-tight" id="total-salary-cap">$38.5M</span>
                        </div>
                        <div class="relative h-2 bg-surface-800 rounded-full overflow-hidden">
                            <div id="salary-progress-bar" class="absolute top-0 left-0 h-full bg-brand shadow-[0_0_10px_var(--accent)] rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs font-mono">
                            <span class="text-gray-500">SPENT: <span id="spent-amount" class="text-white">$0.0M</span></span>
                            <span class="text-brand">REM: <span id="remaining-salary" class="font-bold">$38.5M</span></span>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/5">
                            <h3 class="text-xs font-bold uppercase text-gray-400 tracking-widest">Your Roster</h3>
                            <span class="bg-surface-800 px-2 py-0.5 rounded text-xs font-bold text-white"><span id="roster-count">0</span>/10</span>
                        </div>
                        <div id="roster-slots-container" class="space-y-2">
                            </div>
                    </div>

                    <div class="mt-8">
                        <button id="submit-team-button" disabled class="w-full bg-brand hover:bg-brand-dark text-black font-black text-lg py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all uppercase tracking-wide">
                            Submit Team
                        </button>
                        <p id="submit-team-message" class="text-xs text-center mt-2 text-gray-500"></p>
                    </div>
                </div>
            </aside>
        </div>

        <div id="player-scores-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">Player <span class="text-brand">Scores</span></h2>
            <div id="player-scores-list" class="space-y-8"></div>
        </div>

        <div id="standings-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">League <span class="text-brand">Standings</span></h2>
            <div class="overflow-x-auto">
                <table id="standings-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-surface-800"><tr><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Team</th><th class="px-4 py-3 text-right">Points</th></tr></thead>
                    <tbody class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>

        <div id="rules-view" class="tab-content glass-panel p-4 md:p-8 rounded-xl">
            <h2 class="text-2xl font-black text-white mb-6 uppercase italic">Pool <span class="text-brand">Rules</span></h2>
            <div class="prose prose-invert max-w-none text-sm text-gray-300 space-y-4">
                <p>Draft a team of 10 players under the $38.5M salary cap.</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>1 QB, 3 RB, 3 WR, 1 Flex, 1 D/ST, 1 K</li>
                    <li>Max 3 players per NFL team.</li>
                </ul>
            </div>
        </div>
    </main>

    <div id="mobile-draft-footer" class="mobile-draft-footer xl:hidden">
        <div class="flex flex-col">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Remaining Salary</span>
            <span id="mobile-remaining-salary" class="text-lg font-mono font-bold text-brand">$38.5M</span>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end mr-2">
                 <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Roster</span>
                 <span class="text-sm font-bold text-white"><span id="mobile-roster-count">0</span>/10</span>
            </div>
            <button id="open-roster-drawer" class="bg-surface-800 border border-white/20 text-white hover:bg-surface-700 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide shadow-lg">
                My Team
            </button>
            <button id="mobile-submit-btn" disabled class="bg-brand text-black px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide shadow-[0_0_10px_var(--accent-glow)] disabled:opacity-50 disabled:shadow-none">
                Submit
            </button>
        </div>
    </div>

    <div id="roster-drawer-overlay" class="roster-drawer-overlay xl:hidden"></div>
    <div id="roster-drawer" class="roster-drawer xl:hidden">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-surface-900">
            <h3 class="text-sm font-black text-white uppercase tracking-wider">Your Lineup</h3>
            <button id="close-roster-drawer" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
        <div id="mobile-roster-container" class="flex-1 overflow-y-auto p-4 space-y-2">
            </div>
        <div class="p-4 bg-surface-900 border-t border-white/10">
            <div class="flex justify-between text-xs mb-1 font-bold text-gray-400">
                <span>Cap Usage</span>
                <span id="mobile-drawer-spent">$0.0M / $38.5M</span>
            </div>
            <div class="h-2 bg-surface-800 rounded-full overflow-hidden">
                <div id="mobile-drawer-progress" class="h-full bg-brand" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-surface-800 border border-white/10 rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 id="alert-modal-title" class="text-lg font-bold text-white mb-2">Notice</h3>
            <p id="alert-modal-message" class="text-gray-400 mb-6 text-sm"></p>
            <button id="alert-modal-close-btn" class="w-full bg-surface-700 hover:bg-surface-600 text-white font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <div id="prompt-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-surface-800 border border-brand/30 rounded-xl p-6 max-w-md w-full shadow-2xl">
            <h3 id="prompt-modal-title" class="text-xl font-black text-white mb-2 italic uppercase">Name Team</h3>
            <p id="prompt-modal-message" class="text-gray-400 mb-4 text-sm">Enter a name for your entry.</p>
            <input type="text" id="prompt-modal-input" class="w-full bg-surface-900 border border-white/10 rounded-lg p-3 text-white outline-none focus:border-brand mb-2" placeholder="e.g. Mahomes Depot">
            <div id="prompt-modal-error" class="hidden text-red-500 text-xs mb-4 font-bold"></div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="prompt-modal-cancel-btn" class="px-4 py-2 rounded-lg font-bold text-gray-400 hover:text-white text-sm">Cancel</button>
                <button id="prompt-modal-confirm-btn" class="bg-brand text-black px-6 py-2 rounded-lg font-bold text-sm">Submit</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex flex-col items-center justify-center gap-4">
        <div class="w-10 h-10 border-4 border-surface-700 border-t-brand rounded-full animate-spin"></div>
    </div>

    <script type="module">
        import { getSupabaseClient, checkIsAdmin, clearAdminCache } from './scripts/supabaseClient.js';

        // ==================== NEW COMPACT UI RENDERERS ====================

        // 1. Compact Player Card (The "Tile" look)
        function createPlayerCard(player) {
            if (!player || !player.id) return null;

            const card = document.createElement('div');
            card.className = 'player-card group';
            card.dataset.playerId = String(player.id);
            card.setAttribute('role', 'button');

            // Left: Image + Info
            const leftDiv = document.createElement('div');
            leftDiv.className = 'card-left';

            // Avatar
            // *** FIX: Added explicit width and height and shrink-0 to container ***
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative w-[42px] h-[42px] shrink-0';
            
            const img = document.createElement('img');
            img.src = player.imageUrl || '';
            img.className = 'player-avatar w-full h-full';
            img.loading = 'lazy';
            
            const fallback = document.createElement('div');
            fallback.className = 'player-fallback-initial player-avatar absolute inset-0 w-full h-full';
            fallback.textContent = (player.name?.charAt(0) || '?');
            
            img.onerror = () => { img.style.display='none'; fallback.classList.add('is-visible'); };
            img.onload = () => { fallback.classList.remove('is-visible'); };
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(fallback);

            // Text Info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex flex-col min-w-0';
            
            const nameEl = document.createElement('span');
            nameEl.className = 'text-sm font-bold text-white leading-tight group-hover:text-brand transition-colors truncate';
            nameEl.textContent = player.name;
            
            const metaEl = document.createElement('span');
            metaEl.className = 'text-[10px] font-bold text-gray-500 uppercase tracking-wide mt-0.5 truncate';
            metaEl.textContent = `${player.position} • ${player.team}`;

            infoDiv.appendChild(nameEl);
            infoDiv.appendChild(metaEl);

            leftDiv.appendChild(imgContainer);
            leftDiv.appendChild(infoDiv);

            // Right: Salary
            const rightDiv = document.createElement('div');
            rightDiv.className = 'card-right';
            
            const salaryEl = document.createElement('div');
            salaryEl.className = 'text-sm font-mono font-bold text-brand';
            salaryEl.textContent = formatToMillions(player.salary);

            // Optional: Add "+" button visual on hover
            const addIcon = document.createElement('div');
            addIcon.className = 'text-[10px] text-gray-500 hidden group-hover:block mt-1';
            addIcon.textContent = 'ADD +';

            rightDiv.appendChild(salaryEl);
            rightDiv.appendChild(addIcon);

            card.appendChild(leftDiv);
            card.appendChild(rightDiv);

            return card;
        }

        // 2. Render Roster Slots (Shared by Desktop Sidebar AND Mobile Drawer)
        // We call this twice: once for sidebar (desktop), once for drawer (mobile)
        function renderRosterSlots() {
            const desktopContainer = uiElements.rosterSlotsContainer;
            const mobileContainer = document.getElementById('mobile-roster-container');
            
            if (desktopContainer) desktopContainer.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';

            const slotOrder = ["QB", "RB1", "RB2", "RB3", "WR1", "WR2", "WR3", "FLEX", "DST", "K"];

            // Helper to create a slot row
            const createSlotEl = (slotKey, isMobile) => {
                const playerInSlot = appState.roster[slotKey];
                const slotDiv = document.createElement('div');
                slotDiv.className = isMobile 
                    ? 'flex justify-between items-center p-3 bg-surface-800 rounded-lg border border-white/5' 
                    : 'flex justify-between items-center p-2 bg-surface-800/50 border border-white/5 rounded hover:bg-surface-800 group transition-colors';

                if (playerInSlot) {
                    // Filled State
                    const left = document.createElement('div');
                    left.className = 'flex items-center gap-3';
                    
                    // Label (e.g. QB)
                    const label = document.createElement('span');
                    label.className = 'text-[10px] font-bold text-gray-500 uppercase w-8';
                    label.textContent = slotKey.replace(/\d/, ''); 
                    
                    const name = document.createElement('span');
                    name.className = 'font-bold text-sm text-white truncate max-w-[120px]';
                    name.textContent = playerInSlot.name;

                    left.appendChild(label);
                    left.appendChild(name);

                    const right = document.createElement('div');
                    right.className = 'flex items-center gap-3';
                    
                    const sal = document.createElement('span');
                    sal.className = 'font-mono text-xs text-brand';
                    sal.textContent = formatToMillions(playerInSlot.salary);

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-gray-500 hover:text-red-500 p-1';
                    removeBtn.innerHTML = '✕';
                    removeBtn.onclick = (e) => { e.stopPropagation(); removePlayer(playerInSlot.id, slotKey); };

                    right.appendChild(sal);
                    right.appendChild(removeBtn);
                    
                    slotDiv.appendChild(left);
                    slotDiv.appendChild(right);
                    if(!isMobile) slotDiv.classList.add('border-brand/20'); // Highlight desktop filled
                } else {
                    // Empty State
                    const label = document.createElement('span');
                    label.className = 'text-[10px] font-bold text-gray-600 uppercase w-8';
                    label.textContent = slotKey.replace(/\d/, '');
                    
                    const emptyText = document.createElement('span');
                    emptyText.className = 'text-xs text-gray-700 italic';
                    emptyText.textContent = 'Empty';

                    slotDiv.appendChild(label);
                    slotDiv.appendChild(emptyText);
                }
                return slotDiv;
            };

            slotOrder.forEach(slotKey => {
                if (desktopContainer) desktopContainer.appendChild(createSlotEl(slotKey, false));
                if (mobileContainer) mobileContainer.appendChild(createSlotEl(slotKey, true));
            });
        }

        // ==================== MOBILE DRAWER LOGIC ====================
        const drawer = document.getElementById('roster-drawer');
        const overlay = document.getElementById('roster-drawer-overlay');
        
        function toggleRosterDrawer(open) {
            if (open) {
                drawer.classList.add('open');
                overlay.classList.add('open');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('open');
                document.body.style.overflow = ''; 
            }
        }

        document.getElementById('open-roster-drawer').addEventListener('click', () => toggleRosterDrawer(true));
        document.getElementById('close-roster-drawer').addEventListener('click', () => toggleRosterDrawer(false));
        overlay.addEventListener('click', () => toggleRosterDrawer(false));


        // ==================== STANDARD LOGIC ====================
        
        let supabaseClient;
        try { supabaseClient = getSupabaseClient(); } catch (e) { console.error(e); }

        const CONSTANTS = { INITIAL_SALARY_CAP: 38500000, MAX_PLAYERS_PER_TEAM: 3, ROSTER_SIZE: 10, MAX_ENTRIES_PER_USER: 4, DEBOUNCE_DELAY: 50 };
        const appState = { currentUser: null, currentSession: null, currentSalarySpent: 0, draftedPlayers: {}, roster: { QB: null, RB1: null, RB2: null, RB3: null, WR1: null, WR2: null, WR3: null, FLEX: null, DST: null, K: null }, teamCounts: {}, playersById: {}, allPlayersByPosition: {}, editingTeamId: null };
        const TEAMS = { "BAL": { name: "Baltimore Ravens" }, "BUF": { name: "Buffalo Bills" }, "CLE": { name: "Cleveland Browns" }, "DAL": { name: "Dallas Cowboys" }, "DET": { name: "Detroit Lions" }, "GB": { name: "Green Bay Packers" }, "HOU": { name: "Houston Texans" }, "KC": { name: "Kansas City Chiefs" }, "LAR": { name: "Los Angeles Rams" }, "MIA": { name: "Miami Dolphins" }, "PHI": { name: "Philadelphia Eagles" }, "PIT": { name: "Pittsburgh Steelers" }, "SF": { name: "San Francisco 49ers" }, "TB": { name: "Tampa Bay Buccaneers" } };
        const rosterSlotConfig = { QB: { count: 1, display: "QB", slots: ["QB"] }, RB: { count: 3, display: "RB", slots: ["RB1", "RB2", "RB3"] }, WR: { count: 3, display: "WR", slots: ["WR1", "WR2", "WR3"] }, FLEX: { count: 1, display: "FLEX", slots: ["FLEX"] }, DST: { count: 1, display: "D/ST", slots: ["DST"] }, K: { count: 1, display: "K", slots: ["K"]}, TE: { count: 0, display: "TE", slots: [] } };
        
        const uiElements = {
            playerPoolContainer: document.getElementById('player-pool-container'),
            rosterSlotsContainer: document.getElementById('roster-slots-container'),
            remainingSalaryEl: document.getElementById('remaining-salary'),
            salaryProgressBar: document.getElementById('salary-progress-bar'),
            rosterCountEl: document.getElementById('roster-count'),
            submitTeamButton: document.getElementById('submit-team-button'),
            submitTeamMessage: document.getElementById('submit-team-message'),
            navLinks: document.querySelectorAll('.nav-link'),
            tabContents: document.querySelectorAll('.tab-content'),
            alertModal: document.getElementById('alert-modal'),
            subHeader: document.getElementById('sub-header'),
            loadingOverlay: document.getElementById('loading-overlay'),
            playerScoresList: document.getElementById('player-scores-list'),
            standingsTableBody: document.querySelector('#standings-table tbody'),
            userAuthSection: document.getElementById('user-auth-section'),
            loginButton: document.getElementById('login-button'),
            userProfileSection: document.getElementById('user-profile-section'),
            userEmailDisplay: document.getElementById('user-email-display'),
            logoutButton: document.getElementById('logout-button'),
            promptModal: document.getElementById('prompt-modal'),
            adminNavButton: document.getElementById('nav-admin')
        };

        let updateUITimeout = null;

        document.addEventListener('DOMContentLoaded', () => {
            showLoadingState();
            checkUser(); 
            setupEventListeners();
        });

        function setupEventListeners() {
            uiElements.playerPoolContainer?.addEventListener('click', handlePlayerPoolClick);
            uiElements.navLinks?.forEach(link => link.addEventListener('click', handleNavLinkClick));
            
            document.getElementById('alert-modal-close-btn')?.addEventListener('click', () => uiElements.alertModal?.classList.add('hidden'));
            document.getElementById('prompt-modal-cancel-btn')?.addEventListener('click', hidePromptModal);
            document.getElementById('prompt-modal-confirm-btn')?.addEventListener('click', handleConfirmSubmission);
            
            // Mobile Footer Listeners
            document.getElementById('mobile-submit-btn')?.addEventListener('click', handleSubmitTeamClick);
            
            uiElements.logoutButton?.addEventListener('click', handleLogout);
            uiElements.submitTeamButton?.addEventListener('click', handleSubmitTeamClick);
        }

        async function checkUser() {
            if (!supabaseClient) { hideLoadingState(); return; }
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                window.location.href = "login.html"; 
            } else {
                appState.currentUser = data.session.user;
                appState.currentSession = data.session;
                updateAuthUI(true, data.session.user.email);
                checkAdminStatus();
                const urlParams = new URLSearchParams(window.location.search);
                const teamIdToEdit = urlParams.get('edit_team_id');
                await fetchPlayersAndScores(); 
                if (teamIdToEdit) await loadTeamForEditing(teamIdToEdit);
                else hideLoadingState();
                renderPlayerScoresTab(); 
                fetchAndRenderStandings(); 
            }
        }
        
        // ... [Rest of Auth/Fetch logic] ...
        async function checkAdminStatus() { const isAdmin = await checkIsAdmin(); if (isAdmin) uiElements.adminNavButton?.classList.remove('hidden'); }
        function updateAuthUI(loggedIn, email) { if(loggedIn) { uiElements.loginButton.classList.add('hidden'); uiElements.userProfileSection.classList.remove('hidden'); uiElements.userProfileSection.style.display='flex'; uiElements.userEmailDisplay.textContent=email; } }
        async function handleLogout() { showLoadingState(); clearAdminCache(); await supabaseClient.auth.signOut(); window.location.href="login.html"; }
        
        async function fetchPlayersAndScores() {
            try {
                const [pRes, sRes] = await Promise.all([supabaseClient.from('players').select('*'), supabaseClient.from('player_scores').select('player_id, playoff_round, points')]);
                const scoresMap = (sRes.data||[]).reduce((acc,s)=>{acc[`${s.player_id}-${s.playoff_round}`]=s.points;return acc},{});
                appState.allPlayersByPosition = { QB: [], RB: [], WR: [], TE: [], DST: [], K: [] };
                
                pRes.data.forEach(p => {
                    const scores = [scoresMap[`${p.id}-WC`]||0, scoresMap[`${p.id}-DIV`]||0, scoresMap[`${p.id}-CONF`]||0, scoresMap[`${p.id}-SB`]||0];
                    const player = { ...p, imageUrl: p.position==='DST' ? `https://a.espncdn.com/i/teamlogos/nfl/500/${p.id}.png` : `https://a.espncdn.com/i/headshots/nfl/players/full/${p.id}.png`, playoffScores: scores, totalPoints: scores.reduce((a,b)=>a+b,0) };
                    if (appState.allPlayersByPosition[player.position]) { appState.allPlayersByPosition[player.position].push(player); appState.playersById[player.id] = player; }
                });
                initializeUI();
            } catch(e) { console.error(e); }
        }

        async function loadTeamForEditing(teamId) {
            showLoadingState();
            try {
                const { data } = await supabaseClient.from('user_teams').select(`id, team_name, user_id, team_players(roster_slot, players(id))`).eq('id', teamId).single();
                resetDraftState(); 
                appState.editingTeamId = data.id;
                data.team_players.forEach(tp => {
                   const player = appState.playersById[tp.players.id];
                   if(player) { 
                       appState.roster[tp.roster_slot] = player; 
                       appState.draftedPlayers[player.id] = player; 
                       appState.currentSalarySpent += player.salary;
                       appState.teamCounts[player.team] = (appState.teamCounts[player.team]||0)+1;
                   }
                });
                uiElements.submitTeamButton.textContent = "Update Team";
                document.getElementById('mobile-submit-btn').textContent = "Update";
                triggerUpdateAllUI(); 
            } catch(e) { window.location.href="index.html"; } finally { hideLoadingState(); }
        }

        function initializeUI() {
            renderPlayerPool();
            renderRosterSlots();
            renderSubHeader();
            triggerUpdateAllUI();
            // *** FIX: Initial Sub Header check ***
            updateSubHeaderVisibility('nav-draft-team');
        }

        function triggerUpdateAllUI() {
            if (updateUITimeout) clearTimeout(updateUITimeout);
            updateUITimeout = setTimeout(() => {
                updateSalaryUI();
                updateRosterCount();
                renderRosterSlots(); 
                updatePlayerAvailabilityInPool(); 
                checkRosterFull(); 
            }, 50);
        }

        function updateSalaryUI() {
            const remaining = CONSTANTS.INITIAL_SALARY_CAP - appState.currentSalarySpent;
            const spent = appState.currentSalarySpent;
            const fmt = formatToMillions(remaining);
            
            // Desktop Sidebar
            if (uiElements.remainingSalaryEl) uiElements.remainingSalaryEl.textContent = fmt;
            document.getElementById('spent-amount').textContent = formatToMillions(spent);
            
            // Mobile Footer
            document.getElementById('mobile-remaining-salary').textContent = fmt;
            document.getElementById('mobile-drawer-spent').textContent = `${formatToMillions(spent)} / $38.5M`;

            const pct = (spent / CONSTANTS.INITIAL_SALARY_CAP) * 100;
            if (uiElements.salaryProgressBar) uiElements.salaryProgressBar.style.width = `${Math.min(pct, 100)}%`;
            document.getElementById('mobile-drawer-progress').style.width = `${Math.min(pct, 100)}%`;
        }

        function updateRosterCount() {
            const count = Object.keys(appState.draftedPlayers).length;
            uiElements.rosterCountEl.textContent = count;
            document.getElementById('mobile-roster-count').textContent = count;
        }

        function checkRosterFull() {
            const isFull = Object.keys(appState.draftedPlayers).length === CONSTANTS.ROSTER_SIZE;
            uiElements.submitTeamButton.disabled = !isFull;
            document.getElementById('mobile-submit-btn').disabled = !isFull;
        }
        
        function handlePlayerPoolClick(event) {
            const card = event.target.closest('.player-card');
            const header = event.target.closest('.position-group h2');
            if (header) { header.parentElement.classList.toggle('hidden-section'); return; } // Toggle collapse
            if (card && !card.classList.contains('player-unavailable') && !card.classList.contains('player-drafted')) {
                draftPlayer(appState.playersById[card.dataset.playerId], card);
            }
        }
        
        function draftPlayer(player, card) {
            if (appState.currentSalarySpent + player.salary > CONSTANTS.INITIAL_SALARY_CAP) { showAlertModal('Cap Exceeded', 'Not enough salary.'); return; }
            if ((appState.teamCounts[player.team] || 0) >= CONSTANTS.MAX_PLAYERS_PER_TEAM) { showAlertModal('Limit Reached', 'Too many players from this team.'); return; }
            const slot = findAvailableSlot(player.position);
            if (!slot) { showAlertModal('Position Full', 'No available slot.'); return; }

            appState.roster[slot] = player;
            appState.draftedPlayers[player.id] = player;
            appState.currentSalarySpent += player.salary;
            appState.teamCounts[player.team] = (appState.teamCounts[player.team] || 0) + 1;
            
            card.classList.add('draft-flash');
            setTimeout(() => card.classList.remove('draft-flash'), 500);
            triggerUpdateAllUI();
        }

        function findAvailableSlot(position) {
            const slots = rosterSlotConfig[position]?.slots || [];
            for (const s of slots) if (!appState.roster[s]) return s;
            if (['RB', 'WR', 'TE'].includes(position) && !appState.roster.FLEX) return "FLEX";
            return null;
        }

        function removePlayer(playerId, slotKey) {
            const player = appState.draftedPlayers[playerId];
            if (!player) return;
            appState.currentSalarySpent -= player.salary;
            appState.teamCounts[player.team]--;
            if (appState.teamCounts[player.team] <= 0) delete appState.teamCounts[player.team];
            delete appState.draftedPlayers[playerId];
            appState.roster[slotKey] = null;
            triggerUpdateAllUI();
        }

        function renderPlayerPool() {
            const container = uiElements.playerPoolContainer;
            if (!container) return;
            container.innerHTML = '';
            ["QB", "RB", "WR", "TE", "DST", "K"].forEach(posKey => {
                const players = appState.allPlayersByPosition[posKey];
                if (players?.length > 0) {
                    const section = document.createElement('section');
                    section.id = `section-${posKey}`;
                    section.className = 'position-group mb-6';
                    
                    const header = document.createElement('h2');
                    header.className = 'text-xl font-black text-white mb-3 flex items-center gap-3 uppercase italic tracking-tight sticky top-28 bg-surface-900/95 p-2 z-20 backdrop-blur';
                    header.innerHTML = `<span>${posKey}</span><span class="h-px flex-grow bg-white/10"></span>`;
                    
                    const grid = document.createElement('div');
                    // Compact Grid: 1 col on mobile, 2 on sm, 3 on lg
                    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';
                    
                    players.sort((a,b) => b.salary - a.salary).forEach(p => grid.appendChild(createPlayerCard(p)));
                    section.appendChild(header);
                    section.appendChild(grid);
                    container.appendChild(section);
                }
            });
        }

        function updatePlayerAvailabilityInPool() {
            const remainingSal = CONSTANTS.INITIAL_SALARY_CAP - appState.currentSalarySpent;
            document.querySelectorAll('.player-card').forEach(card => {
                const player = appState.playersById[card.dataset.playerId];
                if (!player) return;
                card.classList.remove('player-drafted', 'player-unavailable');
                
                if (appState.draftedPlayers[player.id]) card.classList.add('player-drafted');
                else if ((appState.teamCounts[player.team] || 0) >= CONSTANTS.MAX_PLAYERS_PER_TEAM) card.classList.add('player-unavailable');
                else if (!findAvailableSlot(player.position)) card.classList.add('player-unavailable');
                else if (player.salary > remainingSal) card.classList.add('player-unavailable');
            });
        }

        function renderSubHeader() {
            if (!uiElements.subHeader) return;
            const positionOrder = Object.keys(appState.allPlayersByPosition); 
            uiElements.subHeader.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center gap-2 overflow-x-auto py-3 no-scrollbar">
                        ${positionOrder.map(posKey => `
                            <a href="#section-${posKey}" 
                               class="flex-shrink-0 px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide border border-white/10 bg-surface-800 text-gray-400 hover:text-white hover:border-brand hover:bg-surface-700 transition-all">
                               ${posKey}
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function formatToMillions(value) {
            if (typeof value !== 'number' || isNaN(value)) return '$0.0M';
            return `$${(value / 1000000).toFixed(1)}M`;
        }

        function showLoadingState(show=true) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function hideLoadingState() { showLoadingState(false); }
        function showAlertModal(title, msg) { document.getElementById('alert-modal-title').textContent=title; document.getElementById('alert-modal-message').textContent=msg; document.getElementById('alert-modal').classList.remove('hidden'); }
        
        // Submit logic (shared)
        function handleSubmitTeamClick() {
            if (Object.keys(appState.draftedPlayers).length !== CONSTANTS.ROSTER_SIZE) { showAlertModal("Roster Incomplete", "Draft 10 players."); return; }
            if (appState.editingTeamId) handleConfirmSubmission(); else showPromptModal();
        }
        function showPromptModal() { document.getElementById('prompt-modal').classList.remove('hidden'); }
        function hidePromptModal() { document.getElementById('prompt-modal').classList.add('hidden'); }
        async function handleConfirmSubmission() {
            // ... Same submission logic as before ...
            const nameInput = document.getElementById('prompt-modal-input');
            let teamName = nameInput.value.trim();
            if(!appState.editingTeamId && !teamName) { document.getElementById('prompt-modal-error').textContent='Name required'; document.getElementById('prompt-modal-error').classList.remove('hidden'); return; }
            
            showLoadingState(); hidePromptModal();
            try {
                if(!appState.editingTeamId) {
                    const {count}=await supabaseClient.from('user_teams').select('*',{count:'exact',head:true}).eq('user_id',appState.currentUser.id);
                    if(count>=CONSTANTS.MAX_ENTRIES_PER_USER) throw new Error('Limit reached');
                    const res=await supabaseClient.from('user_teams').insert({user_id:appState.currentUser.id,team_name:teamName}).select('id').single();
                    if(res.error) throw res.error; appState.editingTeamId=res.data.id;
                }
                const players=Object.keys(appState.roster).filter(k=>appState.roster[k]).map(k=>({team_id:appState.editingTeamId,player_id:appState.roster[k].id,roster_slot:k}));
                await supabaseClient.from('team_players').delete().eq('team_id',appState.editingTeamId);
                await supabaseClient.from('team_players').insert(players);
                showAlertModal("Success", "Team Saved");
                if(!window.location.search.includes('edit')) resetDraftState(); else window.location.href="my-teams.html";
            } catch(e){ showAlertModal("Error",e.message); } finally { hideLoadingState(); }
        }
        function resetDraftState() {
            appState.currentSalarySpent=0; appState.draftedPlayers={}; appState.roster={QB:null,RB1:null,RB2:null,RB3:null,WR1:null,WR2:null,WR3:null,FLEX:null,DST:null,K:null}; appState.teamCounts={}; appState.editingTeamId=null;
            triggerUpdateAllUI();
        }
        
        // ... Render Scores/Standings ...
        function handleNavLinkClick(event) {
            event.preventDefault();
            const href = event.currentTarget.getAttribute('href');
            if (href.includes('.html')) { window.location.href = href; return; }
            
            const targetId = href.startsWith('#') ? href.substring(1) : '';
            if (targetId) {
                uiElements.navLinks.forEach(nav => nav.classList.remove('active'));
                event.currentTarget.classList.add('active');
                uiElements.tabContents.forEach(c => c.classList.toggle('active', c.id === targetId));
                
                // *** FIX: Update sub header visibility on click ***
                updateSubHeaderVisibility(event.currentTarget.id);
            }
        }

        // *** FIX: New Helper Function ***
        function updateSubHeaderVisibility(activeLinkId) {
            if (activeLinkId === 'nav-draft-team') {
                uiElements.subHeader.classList.remove('sub-header-hidden');
            } else {
                uiElements.subHeader.classList.add('sub-header-hidden');
            }
        }

        function renderPlayerScoresTab() {
            const container = uiElements.playerScoresList; if(!container) return; container.innerHTML = '';
            ["QB", "RB", "WR", "TE", "DST", "K"].forEach(pos => {
                const players = appState.allPlayersByPosition[pos]; if(!players?.length) return;
                const wrapper = document.createElement('div'); wrapper.className = 'glass-panel p-4 md:p-6 rounded-xl';
                wrapper.innerHTML = `<h3 class="text-lg font-black text-brand mb-4 border-b border-white/5 pb-2">${pos}</h3>`;
                const table = document.createElement('table'); table.className = 'w-full text-sm text-left text-gray-400';
                table.innerHTML = `<thead class="text-xs uppercase text-gray-500"><tr><th class="py-2">Player</th><th class="text-right">Total</th></tr></thead><tbody class="divide-y divide-white/5">${players.sort((a,b)=>b.totalPoints-a.totalPoints).map(p => `<tr><td class="py-2 text-white font-medium text-xs md:text-sm">${p.name} <span class="text-gray-600 ml-1">${p.team}</span></td><td class="text-right font-mono text-brand">${p.totalPoints.toFixed(1)}</td></tr>`).join('')}</tbody>`;
                wrapper.appendChild(table); container.appendChild(wrapper);
            });
        }
        async function fetchAndRenderStandings() {
            const tbody = uiElements.standingsTableBody; tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500 animate-pulse">Updating...</td></tr>`;
            try {
                const { data } = await supabaseClient.rpc('get_standings');
                tbody.innerHTML = ''; if(!data?.length) { tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-600">No teams.</td></tr>`; return; }
                data.forEach((team, i) => {
                    const row = tbody.insertRow(); row.className = i < 3 ? 'bg-white/5' : '';
                    row.innerHTML = `<td class="px-4 py-3 font-mono font-bold ${i===0?'text-yellow-400':i===1?'text-gray-300':i===2?'text-orange-400':'text-gray-500'}">#${team.rank}</td><td class="px-4 py-3 font-bold text-white text-xs md:text-sm">${team.team_name}</td><td class="px-4 py-3 text-right font-mono font-bold text-brand">${team.total_points.toFixed(1)}</td>`;
                });
            } catch(e) {}
        }
    </script>
</body>
</html>
